<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calculadora Dosis de Insulina - Hospital Universitario La Merced</title>
  <style>
    /* Reset básico para asegurar box-sizing */
    *, *::before, *::after {
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 1rem auto;
      padding: 0 1rem;
      background-image: url('Imagen de fondo presentación.png');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      background-color: #f9f9f9;
      color: #333;
      font-size: 1em;
    }
    h1, h2 {
      color: #008000;
      font-size: 1.8em;
      margin-top: 1.5rem;
      margin-bottom: 0.8rem;
    }
    h1 {
      text-align: center;
      font-size: 2.2em;
    }
    .hospital-info {
      text-align: center;
      margin-bottom: 1.5rem;
    }
    .hospital-info h2 {
        font-size: 1.5em;
        margin-bottom: 0.2em;
        color: #008000;
    }
    .hospital-info p {
        font-size: 0.9em;
        color: #555;
        margin-top: 0;
    }
    .main-title {
        text-align: center;
        font-size: 3.6em;
        color: #008000;
        font-weight: bold;
        margin-top: 1rem;
        margin-bottom: 1.5rem;
    }
    label {
      font-weight: bold;
      display: block;
      margin-top: 1em;
    }
    input[type=number], select {
      width: 100%;
      max-width: 200px;
      padding: 0.5em;
      margin-top: 0.2em;
      margin-bottom: 0.6em;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1em;
    }
    .checkbox-inline {
      display: inline-block;
      margin-right: 1.5em;
      font-size: 1em;
    }
    .checkbox-inline input {
      margin-right: 0.5em;
      vertical-align: middle;
    }
    #datosAyerContainer, #correccionRatioContainerAvanzado {
      background: #e6ffe6;
      border: 1px solid #99e699;
      padding: 1em;
      margin-top: 0.8em;
      border-radius: 6px;
    }
    button {
      margin-top: 1.2em;
      padding: 0.7em 1.2em;
      background-color: #008000;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 1.1em;
      cursor: pointer;
      width: auto;
      display: block;
    }
    button:hover {
      background-color: #005500;
    }
    .resultado {
      margin-top: 1.5em;
      font-size: 1.3em;
      font-weight: bold;
      color: #004d00;
    }
    .resultado-aviso {
        font-size: 0.9em;
        color: #cc0000;
        margin-top: 0.5em;
        font-weight: normal;
    }
    .resultado-aviso.alerta-correccion {
        color: orange;
    }
    pre.pasos {
      background: #e6ffe6;
      border: 1px solid #99e699;
      padding: 1em;
      white-space: pre-wrap;
      margin-top: 1em;
      border-radius: 6px;
      font-size: 0.9em;
      line-height: 1.4;
    }
    .pasos-correccion-ratio, .pasos-calculo-ratio-basico {
        background: #e6ffe6;
        border: 1px solid #99e699;
        padding: 1em;
        white-space: pre-wrap;
        margin-top: 1em;
        border-radius: 6px;
        font-size: 0.85em;
        line-height: 1.4;
    }
    .error-message {
      color: red;
      font-size: 0.85em;
      margin-top: -0.4em;
      margin-bottom: 0.4em;
      display: none;
    }
    .logo-container {
        text-align: center;
        margin-bottom: 1.5rem;
    }
    .logo-container img {
        max-width: 400px;
        height: auto;
        display: block;
        margin: 0 auto;
    }
    .disclaimer-text p {
        margin-bottom: 0.5em;
    }
    .aviso-extra {
        font-size: 0.95em;
        color: #555;
        margin-top: 1em;
        line-height: 1.4;
    }
    .mensaje-rojo {
        color: red;
        font-weight: bold;
        margin-top: 0.8em;
    }
    /* Estilo para el mensaje de corrección alta en rojo y negrita */
    #correccionAltaAviso {
        color: red;
        font-weight: bold;
    }
    .input-error {
        border-color: red !important;
    }

    /* Estilos específicos para el texto de ajuste de deporte */
    .ajuste-texto {
        font-size: 1em;
        line-height: 1.4;
    }
    .ajuste-ejemplos {
        font-style: italic;
        font-size: 0.9em;
        line-height: 1.4;
        margin-top: 0.5em;
    }

    .recomendaciones-box {
        background-color: #008000;
        color: white;
        padding: 1em;
        margin-top: 1em;
        border-radius: 6px;
        text-align: center;
    }

    .recomendaciones-box h3 {
        color: white;
        margin: 0;
        font-size: 1.5em;
        font-weight: bold;
    }
    /* Nuevos estilos para centrar el pie de página */
    .footer-container {
        text-align: center;
    }
    .footer-text p {
      color: #008000;
      font-weight: bold;
      text-align: center;
    }

    /* Media Queries para pantallas pequeñas (smartphones) */
    @media (max-width: 600px) {
      body {
        font-size: 1.1em;
        padding: 0 0.8rem;
      }
      h1 {
        font-size: 1.8em;
      }
      h2 {
        font-size: 1.4em;
      }
      label, input[type=number], select {
        font-size: 1.1em;
      }
      input[type=number], select {
        max-width: 100%;
        padding: 0.6em;
      }
      button {
        font-size: 1.1em;
        width: 100%;
        padding: 0.8em 1em;
      }
      .resultado {
        font-size: 1.2em;
      }
      pre.pasos, .pasos-correccion-ratio, .pasos-calculo-ratio-basico {
        font-size: 0.95em;
      }
      .checkbox-inline {
        display: block;
        margin-right: 0;
        margin-bottom: 0.5em;
      }
      .logo-container img {
        max-width: 150px;
      }
    }
  </style>
</head>
<body>

  <div class="logo-container">
    <img src="COLOR_3_TINTAS.jpg" alt="Logo Área de Gestión Sanitaria de Osuna" />
  </div>

  <div class="hospital-info">
    <h1>Hospital Universitario La Merced</h1>
   

    <h1 style="color: green;">CALCULADORA BÁSICA DE DOSIS DE INSULINA RÁPIDA</h1>

  </div>

  <div class="disclaimer-text">
    <p>Esta herramienta tiene como objetivo ayudar para el cálculo de la dosis de insulina rápida a administrar, simplificando operaciones complejas y ayudando al paciente
a aplicar lo aprendido durante su Educación Terapéutica en 
Diabetes.</p>
    <p>No uses esta calculadora si todavía 
 no has recibido formación en consulta. Estos cálculos son solo una parte de la estrategia de autocuidado.</p>
  </div>

  <hr>

  <p><strong>Edición en pruebas.
 Versión 1a.</strong></p>

  <h2>1. Insulina y glucemia</h2>

  <label for="tipoInsulina">¿Qué tipo de insulina rápida usa?:</label>
  <select id="tipoInsulina">
    <option value="" selected>Seleccionar</option>
    <option value="Apidra">Apidra (Glulisina)</option>
    <option value="Novorapid">Novorapid (Aspart)</option>
    <option value="Humalog">Humalog (Lispro)</option>
    <option value="Fiasp">Fiasp (Aspart)</option>
  </select>
  <span class="error-message" id="errorTipoInsulina">No ha indicado el tipo de insulina rápida que usa.</span>

  <label for="rapida">Unidades totales de insulina rápida diaria (de media en los últimos 2 días):</label>
  <input id="rapida" type="number" min="0" step="0.1" />
  <span class="error-message" id="errorRapida">Introduce un valor válido entre 3 y 100.</span>

  <label for="lenta">Unidades totales de insulina lenta diaria 
(de media en los últimos 2 días):</label>
  <input id="lenta" type="number" min="0" step="0.1" />
  <span class="error-message" id="errorLenta">Introduce un valor válido entre 5 y 100.</span>

  <label for="glucemiaActual">¿Cuál es la glucemia ANTES de esta comida?
 (mg/dL):</label>
  <input id="glucemiaActual" type="number" min="0" step="1" />
  <span class="error-message" id="errorGlucemiaActual">Introduce un valor válido entre 55 y 450.</span>
  <p class="mensaje-rojo" id="emergenciaAviso" style="display:none; font-weight: bold;">¡ATENCIÓN: Valores inferiores a 55 mg/dl o superiores a 450, pueden ser una EMERGENCIA DIABETOLÓGICA.
 Confirme la glucemia (haga una prueba capilar para comprobar el resultado). Solucione esta situación cuanto antes o llame a los servicios de emergencia (112)</p>

  <label for="flechaGlucemia">Si tiene Monitorización, indica cómo está la flecha:</label>
  <select id="flechaGlucemia">
    <option value="estable">Estable</option>
    <option value="ascenso_lento">Ascenso lento</option>
    <option value="ascenso_rapido">Ascenso rápido</option>
    <option value="descenso_lento">Descenso lento</option>
    <option value="descenso_rapido">Descenso rápido</option>
  </select>

  <label for="glucemiaObjetivo">¿Cuál es la glucemia que quiere tener DESPUÉS de 3 horas?
 (mg/dL) (Por defecto 120). Por la noche, o en pacientes muy sensibles o con fragilidad, puede indicarse 150 o un valor mayor):</label>
  <input id="glucemiaObjetivo" type="number" min="0" step="1" value="120" />
  <span class="error-message" id="errorGlucemiaObjetivo">Introduce un valor válido entre 100 y 180.</span>

  <hr>

  <h2>2.
 Pauta habitual de insulina de esta comida:</h2>

  <label for="dosisHabitualComidaActual">Pauta habitual (Unidades):</label>
  <input id="dosisHabitualComidaActual" type="number" min="0" step="0.1" />
  <p style="color: black;">Si va a aplicar una corrección de glucemia sin comer, indique de pauta “0”.</p>
  <span class="error-message" id="errorDosisHabitualComidaActual">Introduce un valor válido entre 0 y el total de insulina rápida diaria.</span>


  <label for="comidaComposicion">Composición de esta comida:</label>
  <select id="comidaComposicion">
    <option value="normal" selected>Normal</option>
    <option value="liviana">Liviana</option>
    <option value="pesada">Pesada</option>
  </select>
  <div id="ajusteLivianaContainer" style="display:none;">
    <p>Se trata de una comida con menos proteína y/o grasa de lo habitual.
 Para evitar una hipoglucemia, es recomendable RESTAR una dosis de insulina entre 0.5 y 3 unidades de insulina para compensarlo.</p>
    <label for="ajusteLiviana">Ajuste de dosis a REDUCIR (Unidades):</label>
    <input id="ajusteLiviana" type="number" min="0.5" max="3" step="0.5" />
    <span class="error-message" id="errorAjusteLiviana">Introduce un valor válido entre 0.5 y 3.</span>
  </div>
  <div id="ajustePesadaContainer" style="display:none;">
    <p>Se trata de una comida con más proteína y/o grasa de lo habitual.
 Para evitar una hiperglucemia de forma tardía, es recomendable SUMAR una dosis de insulina entre 0.5 y 3 unidades de insulina para compensarlo.</p>
    <label for="ajustePesada">Ajuste de dosis (Unidades):</label>
    <input id="ajustePesada" type="number" min="0.5" max="3" step="0.5" />
    <span class="error-message" id="errorAjustePesada">Introduce un valor válido entre 0.5 y 3.</span>
  </div>

  <label for="deporteAntes">¿Hizo deporte/trabajo físico antes de esta comida?</label>
  <select id="deporteAntes">
    <option value="no" selected>No</option>
    <option value="si">Sí</option>
  </select>
  <div id="ajusteDeporteAntesContainer" style="display:none;">
    <p>
      El ejercicio aumenta la sensibilidad de 
 tu cuerpo a la insulina. Si has realizado deporte o trabajo físico antes de comer, es posible que necesites una dosis menor de insulina para evitar una hipoglucemia.
 </p>
    <p>
      Ajuste recomendado: REDUCE la dosis entre 1 y 4 unidades.
 Elige el valor en función de la intensidad y la duración del ejercicio.
 Por ejemplo:
    </p>
    <div class="ajuste-ejemplos">
      <p>
        Ejercicio ligero o corto (paseo, estiramientos):
        <br>
        Reduce la dosis en 1 unidad.
 </p>
      <p>
        Ejercicio moderado (correr, nadar, bicicleta): Reduce
        <br>
        la dosis en 2 unidades.
 </p>
      <p>
        Ejercicio intenso o prolongado (deportes de equipo,
        <br>
        gimnasio): Reduce la dosis en 3 a 4 unidades.
 </p>
    </div>
    <label for="ajusteDeporteAntes">Ajuste de dosis a REDUCIR (Unidades):</label>
    <input id="ajusteDeporteAntes" type="number" min="0.5" max="5" step="0.5" />
    <span class="error-message" id="errorAjusteDeporteAntes">Introduce un valor válido entre 0.5 y 5.</span>
  </div>

  <label for="deporteDespues">¿Va a hacer deporte/trabajo físico después de esta comida?</label>
  <select id="deporteDespues">
    <option value="no" selected>No</option>
    <option value="si">Sí</option>
  </select>
  <div id="ajusteDeporteDespuesContainer" style="display:none;">
    <p>
      La insulina que te inyectes ahora actuará durante las próximas 3 horas, si en este tiempo realizas un consumo extra 
 de glucosa debido al ejercicio o trabajo intenso, puedes tener una hipoglucemia.
 Para evitarla, es importante reducir la dosis de insulina que vas a administrar.
 </p>
    <p>
      Ajuste recomendado: REDUCE la dosis entre 1 y 4 unidades.
 Elige el valor en función de la intensidad y la duración del ejercicio.
 Por ejemplo:
    </p>
    <div class="ajuste-ejemplos">
      <p>
        Ejercicio ligero o corto (paseo, estiramientos):
        <br>
        Reduce la dosis en 1 unidad.
 </p>
      <p>
        Ejercicio moderado (correr, nadar, bicicleta): Reduce
        <br>
        la dosis en 2 unidades.
 </p>
      <p>
        Ejercicio intenso o prolongado (deportes de equipo,
        <br>
        gimnasio): Reduce la dosis en 3 a 4 unidades.
 </p>
    </div>
    <label for="ajusteDeporteDespues">Ajuste de dosis a REDUCIR (Unidades):</label>
    <input id="ajusteDeporteDespues" type="number" min="0.5" max="5" step="0.5" />
    <span class="error-message" id="errorAjusteDeporteDespues">Introduce un valor válido entre 0.5 y 5.</span>
  </div>

  <label for="hipoglucemiaAyer">¿Ayer tuvo usted hipoglucemia después de esta comida?:</label>
  <select id="hipoglucemiaAyer">
    <option value="no" selected>No</option>
    <option value="si">Sí</option>
  </select>

  <hr>

  <h2>3.
 Cálculo</h2>
  <button onclick="calcularInsulina()">Calcular dosis de insulina</button>

  <div class="recomendaciones-box" id="recomendacionesBox" style="display:none;">
      <h3>RECOMENDACIONES</h3>
      <p id="recomendacionesTexto"></p>
  </div>
  
  <p class="mensaje-rojo" id="avisoValidacion" style="display:none; font-weight: bold;">Revise los valores introducidos, puede que no sean válidos.</p>
  <div class="resultado" id="resultado"></div>
  <p class="resultado-aviso" id="dosisAltaAviso" style="display:none;">⚠️ Esta es una dosis alta.
 Por favor, revise los datos introducidos y/o consulte con su profesional sanitario.</p>
  <p class="resultado-aviso" id="correccionAltaAviso" style="display:none;">⚠️ Dosis de corrección alta ¿Está seguro?</p>
  <p class="mensaje-rojo" id="riesgoHipoglucemiaAviso" style="display:none;">⚠️ RIESGO DE HIPOGLUCEMIA: Puede que sea necesario tomar carbohidratos extras.</p>
  <p style="color: red; font-weight: bold; display: none;"
 id="avisoPautaHabitual">No ha registrado la dosis de insulina de esta comida.
 El resultado obtenido solo es útil si va a corregir su nivel actual de glucosa, pero sin comer.</p>
  <p style="color: black; font-weight: bold;">Compruebe los datos introducidos. Los resultados ofrecidos son únicamente orientativos y no sustituyen la consulta ni las indicaciones de su profesional sanitario.</p>
  <p class="aviso-extra">Puede que esta dosis de insulina necesite algún ajuste extra como es el caso de situaciones por enfermedad (fiebre, diarrea,...), algunos tratamientos (corticoides,...), menstruación,... que pueden hacer variar estos cálculos.
 Consulta con tu profesional.</p>

  <pre class="pasos" id="pasos"></pre>

    <hr>

  <div class="footer-container">
    <div class="footer-text">
      <p>DESARROLLADO POR:</p>
    </div>
    <div class="footer-author-info">
      <p><strong>Francisco José Osuna Navarro</strong></p>
      <p>Enfermero de la consulta EPA de Diabetes</p>
    </div>
    <div class="larger-spacing"></div>
    <a href="https://fosunan.github.io/Calculadoras-de-insulina/" style="text-decoration: none;">
      <button>Volver al Menú Principal</button>
    </a>
  </div>

  <script>
    // Función genérica para validar input y mostrar mensaje de error
    function validateInput(inputId, errorId, condition, errorMessage) {
      const input = document.getElementById(inputId);
      const errorSpan = document.getElementById(errorId);
      const value = input.value;
      if (!condition(value)) {
        input.classList.add('input-error');
        errorSpan.textContent = errorMessage;
        errorSpan.style.display = 'block';
        return false;
      } else {
        input.classList.remove('input-error');
        errorSpan.style.display = 'none';
        return true;
      }
    }

    // Funciones de validación específicas
    const isPositiveNumber = (value) => parseFloat(value) > 0;
    const isNonNegativeNumber = (value) => parseFloat(value) >= 0;
    const isInRange = (value, min, max) => {
        const numValue = parseFloat(value);
        return !isNaN(numValue) && numValue >= min && numValue <= max;
    };
    // Redondeo a la media unidad más cercana
    function roundToHalf(num) {
        return Math.round(num * 2) / 2;
    }

    // Event listeners para mostrar/ocultar campos de ajuste
    document.getElementById('comidaComposicion').addEventListener('change', function() {
        document.getElementById('ajusteLivianaContainer').style.display = 'none';
        document.getElementById('ajustePesadaContainer').style.display = 'none';
        if (this.value === 'liviana') {
            document.getElementById('ajusteLivianaContainer').style.display = 'block';
        } else if (this.value === 'pesada') {
            document.getElementById('ajustePesadaContainer').style.display = 'block';
        }
 
 
    });

    document.getElementById('deporteAntes').addEventListener('change', function() {
        document.getElementById('ajusteDeporteAntesContainer').style.display = (this.value === 'si') ? 'block' : 'none';
    });
    document.getElementById('deporteDespues').addEventListener('change', function() {
        document.getElementById('ajusteDeporteDespuesContainer').style.display = (this.value === 'si') ? 'block' : 'none';
    });
    // Función principal para calcular la dosis de insulina
    function calcularInsulina() {
      // Ocultar todos los mensajes de error y aviso antes de validar y calcular
      document.getElementById('emergenciaAviso').style.display = 'none';
      document.getElementById('avisoPautaHabitual').style.display = 'none';
      document.getElementById('dosisAltaAviso').style.display = 'none';
      document.getElementById('correccionAltaAviso').style.display = 'none';
      document.getElementById('riesgoHipoglucemiaAviso').style.display = 'none';
      document.getElementById('avisoValidacion').style.display = 'none';
      document.getElementById('resultado').textContent = '';
      document.getElementById('pasos').textContent = '';
      document.getElementById('pasos').style.display = 'none';
      document.getElementById('recomendacionesBox').style.display = 'none'; // Ocultar el cuadro de recomendaciones al inicio

      const tipoInsulina = document.getElementById('tipoInsulina').value;
      const rapida = parseFloat(document.getElementById('rapida').value);
      const lenta = parseFloat(document.getElementById('lenta').value);
      const constanteCorreccion = 1800;
      let glucemiaActual = document.getElementById('glucemiaActual').value;
      const flechaGlucemia = document.getElementById('flechaGlucemia').value;
      const glucemiaObjetivo = parseFloat(document.getElementById('glucemiaObjetivo').value);
      const dosisHabitualComidaActual = parseFloat(document.getElementById('dosisHabitualComidaActual').value);
      const comidaComposicion = document.getElementById('comidaComposicion').value;
      const deporteAntes = document.getElementById('deporteAntes').value;
      const deporteDespues = document.getElementById('deporteDespues').value;
      const hipoglucemiaAyer = document.getElementById('hipoglucemiaAyer').value;
      // Obtener valores de ajuste de los nuevos campos (ahora son positivos, pero se restarán)
      let ajusteLiviana = (comidaComposicion === 'liviana') ?
      parseFloat(document.getElementById('ajusteLiviana').value) || 0 : 0;
      let ajustePesada = (comidaComposicion === 'pesada') ? parseFloat(document.getElementById('ajustePesada').value) || 0 : 0;
      let ajusteDeporteAntes = (deporteAntes === 'si') ? parseFloat(document.getElementById('ajusteDeporteAntes').value) || 0 : 0;
      let ajusteDeporteDespues = (deporteDespues === 'si') ?
      parseFloat(document.getElementById('ajusteDeporteDespues').value) || 0 : 0;
      

      // Validación de tipo de insulina
      if (tipoInsulina === "") {
          document.getElementById('errorTipoInsulina').style.display = 'block';
          document.getElementById('avisoValidacion').style.display = 'block';
          document.getElementById('tipoInsulina').classList.add('input-error');
          return;
      } else {
          document.getElementById('errorTipoInsulina').style.display = 'none';
          document.getElementById('tipoInsulina').classList.remove('input-error');
      }

      // Validación especial para glucemia con texto
      const glucemiaValue = glucemiaActual.toLowerCase().trim();
      if (glucemiaValue === 'lo' || glucemiaValue === 'hi') {
        document.getElementById('emergenciaAviso').style.display = 'block';
        document.getElementById('glucemiaActual').classList.add('input-error');
        document.getElementById('avisoValidacion').style.display = 'block';
        return;
      }
      glucemiaActual = parseFloat(glucemiaActual);
      // Validaciones de rango
      let valid = true;
      valid = validateInput('rapida', 'errorRapida', (val) => isInRange(val, 3, 100), 'Introduce un valor válido entre 3 y 100.') && valid;
      valid = validateInput('lenta', 'errorLenta', (val) => isInRange(val, 5, 100), 'Introduce un valor válido entre 5 y 100.') && valid;
      // Validación de glucemia
      const isGlucemiaValid = isInRange(glucemiaActual, 55, 450);
      valid = validateInput('glucemiaActual', 'errorGlucemiaActual', (val) => isGlucemiaValid, 'Introduce un valor válido entre 55 y 450.') && valid;
      // Validar si el valor de la glucemia es menor a 55 o mayor a 450 para mostrar el aviso de emergencia
      if (!isGlucemiaValid && !isNaN(glucemiaActual)) {
        document.getElementById('emergenciaAviso').style.display = 'block';
        document.getElementById('avisoValidacion').style.display = 'block';
        return;
      }

      valid = validateInput('glucemiaObjetivo', 'errorGlucemiaObjetivo', (val) => isInRange(val, 100, 180), 'Introduce un valor válido entre 100 y 180.') && valid;
      // Nueva validación para dosisHabitualComidaActual
      const dosisHabitualMax = parseFloat(document.getElementById('rapida').value);
      valid = validateInput('dosisHabitualComidaActual', 'errorDosisHabitualComidaActual', (val) => isInRange(val, 0, dosisHabitualMax), `Introduce un valor válido entre 0 y ${dosisHabitualMax}.`) && valid;
      // Nuevas validaciones para los campos de ajuste (ahora positivos)
      if (comidaComposicion === 'liviana') {
          valid = validateInput('ajusteLiviana', 'errorAjusteLiviana', (val) => isInRange(val, 0.5, 3), 'Introduce un valor válido entre 0.5 y 3.') && valid;
      } else if (comidaComposicion === 'pesada') {
          valid = validateInput('ajustePesada', 'errorAjustePesada', (val) => isInRange(val, 0.5, 3), 'Introduce un valor válido entre 0.5 y 3.') && valid;
      }
      if (deporteAntes === 'si') {
          valid = validateInput('ajusteDeporteAntes', 'errorAjusteDeporteAntes', (val) => isInRange(val, 0.5, 5), 'Introduce un valor válido entre 0.5 y 5.') && valid;
      }
      if (deporteDespues === 'si') {
          valid = validateInput('ajusteDeporteDespues', 'errorAjusteDeporteDespues', (val) => isInRange(val, 0.5, 5), 'Introduce un valor válido entre 0.5 y 5.') && valid;
      }


      if (!valid) {
        document.getElementById('resultado').textContent = '';
        document.getElementById('pasos').textContent = '';
        document.getElementById('avisoValidacion').style.display = 'block';
        return;
      }
      
      // Manejo del aviso de pauta habitual 0 o en blanco
      if (dosisHabitualComidaActual === 0 || isNaN(dosisHabitualComidaActual)) {
          document.getElementById('avisoPautaHabitual').style.display = 'block';
      }


      const totalInsulinaDiaria = rapida + lenta;
      let fsi = 0;
      if (totalInsulinaDiaria > 0) {
        fsi = constanteCorreccion / totalInsulinaDiaria;
      } else {
        document.getElementById('resultado').textContent = 'Error: La suma de insulina rápida y lenta no puede ser cero para calcular el FSI.';
        document.getElementById('pasos').textContent = '';
        return;
      }
      
      let pasosTexto = `Pasos del cálculo:\n\n`;
      const originalGlucemiaActual = glucemiaActual;
      let gp15 = 0; // Nuevo parámetro GP15
      
      pasosTexto += `1.
 Cálculo del nuevo parámetro GP15:\n`;
      pasosTexto += `   Glucemia ANTES de la comida: ${originalGlucemiaActual} mg/dL\n`;
      switch (flechaGlucemia) {
        case 'estable':
          gp15 = originalGlucemiaActual;
          pasosTexto += `   Flecha (Estable): GP15 = Glucemia ANTES de la comida = ${gp15.toFixed(1)} mg/dL\n`;
          break;
        case 'ascenso_lento':
          gp15 = originalGlucemiaActual + 30;
          pasosTexto += `   Flecha (Ascenso lento): GP15 = Glucemia ANTES + 30 = ${originalGlucemiaActual} + 30 = ${gp15.toFixed(1)} mg/dL\n`;
 break;
        case 'ascenso_rapido':
          gp15 = originalGlucemiaActual + 60;
          pasosTexto += `   Flecha (Ascenso rápido): GP15 = Glucemia ANTES + 60 = ${originalGlucemiaActual} + 60 = ${gp15.toFixed(1)} mg/dL\n`;
 break;
        case 'descenso_lento':
          gp15 = originalGlucemiaActual - 20;
          pasosTexto += `   Flecha (Descenso lento): GP15 = Glucemia ANTES - 20 = ${originalGlucemiaActual} - 20 = ${gp15.toFixed(1)} mg/dL\n`;
 break;
        case 'descenso_rapido':
          gp15 = originalGlucemiaActual - 40;
          pasosTexto += `   Flecha (Descenso rápido): GP15 = Glucemia ANTES - 40 = ${originalGlucemiaActual} - 40 = ${gp15.toFixed(1)} mg/dL\n`;
 break;
      }
      pasosTexto += `   El valor del GP15 es: ${gp15.toFixed(1)} mg/dL\n\n`;
      let ajusteGlucemiaFlecha = 0;
      pasosTexto += `2. Ajuste de Glucemia para el cálculo de corrección:\n`;
      pasosTexto += `   Glucemia actual inicial: ${originalGlucemiaActual} mg/dL\n`;
      switch (flechaGlucemia) {
        case 'ascenso_lento':
          ajusteGlucemiaFlecha = 25;
          pasosTexto += `   Flecha (Ascenso lento): Glucemia actual + 25 mg/dL\n`;
          break;
        case 'ascenso_rapido':
          ajusteGlucemiaFlecha = 50;
          pasosTexto += `   Flecha (Ascenso rápido): Glucemia actual + 50 mg/dL\n`;
          break;
        case 'descenso_lento':
          ajusteGlucemiaFlecha = -25;
          pasosTexto += `   Flecha (Descenso lento): Glucemia actual - 25 mg/dL\n`;
          break;
        case 'descenso_rapido':
          ajusteGlucemiaFlecha = -50;
          pasosTexto += `   Flecha (Descenso rápido): Glucemia actual - 50 mg/dL\n`;
          break;
        case 'estable':
        default:
          ajusteGlucemiaFlecha = 0;
          pasosTexto += `   Flecha (Estable): Glucemia actual + 0 mg/dL\n`;
          break;
      }
      glucemiaActual += ajusteGlucemiaFlecha;
      pasosTexto += `   Glucemia actual ajustada: ${glucemiaActual.toFixed(1)} mg/dL\n\n`;
      // 3. Cálculo de la Dosis de Corrección (DC)
      let dosisCorreccion = 0;
      let diferenciaGlucemia = glucemiaActual - glucemiaObjetivo;
      pasosTexto += `3. Cálculo de la Dosis de Corrección (DC):\n`;
      pasosTexto += `   Glucemia ajustada: ${glucemiaActual.toFixed(1)} mg/dL\n`;
      pasosTexto += `   Glucemia objetivo: ${glucemiaObjetivo} mg/dL\n`;
      pasosTexto += `   Diferencia de Glucemia = Glucemia ajustada - Glucemia objetivo = ${glucemiaActual.toFixed(1)} - ${glucemiaObjetivo} = ${diferenciaGlucemia.toFixed(1)} mg/dL\n`;
      pasosTexto += `   Factor de Sensibilidad a la Insulina (FSI) = Constante de Corrección / (Insulina Rápida + Lenta) = ${constanteCorreccion} / (${rapida} + ${lenta}) = ${fsi.toFixed(2)}\n`;
      if (diferenciaGlucemia !== 0) {
        dosisCorreccion = diferenciaGlucemia / fsi;
        pasosTexto += `   Dosis de Corrección (DC) = Diferencia de Glucemia / FSI = ${diferenciaGlucemia.toFixed(1)} / ${fsi.toFixed(2)} = ${dosisCorreccion.toFixed(1)} U\n`;
        // Lógica para el mínimo de corrección negativa
        if (originalGlucemiaActual < 70 && dosisCorreccion > -1) {
            dosisCorreccion = -1;
            pasosTexto += `   Ajuste: Glucemia actual < 70 mg/dL, dosis de corrección mínima -1.0 U.\n`;
        } else if (originalGlucemiaActual < 100 && dosisCorreccion > -0.5) {
            dosisCorreccion = -0.5;
            pasosTexto += `   Ajuste: Glucemia actual < 100 mg/dL, dosis de corrección mínima -0.5 U.\n`;
        }

        dosisCorreccion = roundToHalf(dosisCorreccion);
        pasosTexto += `   Dosis de Corrección (DC) redondeada: ${dosisCorreccion.toFixed(1)} U\n\n`;
        if (Math.abs(dosisCorreccion) > 4 && diferenciaGlucemia >= 0) {
            document.getElementById('correccionAltaAviso').style.display = 'block';
        }
      } else {
        dosisCorreccion = 0;
        pasosTexto += `   Glucemia ajustada (${glucemiaActual.toFixed(1)}) es igual a Glucemia objetivo (${glucemiaObjetivo}).
 No se requiere dosis de corrección (DC = 0 U).\n\n`;
      }


      // 4. Dosis habitual de insulina para la comida
      let dosisHabitual = dosisHabitualComidaActual;
      pasosTexto += `4. Dosis habitual de insulina para esta comida:\n`;
      pasosTexto += `   Dosis Habitual = ${dosisHabitual.toFixed(1)} U\n\n`;
      // 5. Ajustes por Composición de Comida y Actividad Física
      pasosTexto += `5. Ajustes adicionales:\n`;
      // Ajuste por composición de comida
      let ajusteComida = 0;
      if (comidaComposicion === 'liviana') {
          ajusteComida = -ajusteLiviana;
          pasosTexto += `   Ajuste por comida Liviana: ${ajusteComida.toFixed(1)} U\n`;
      } else if (comidaComposicion === 'pesada') {
          ajusteComida = ajustePesada;
          pasosTexto += `   Ajuste por comida Pesada: ${ajusteComida.toFixed(1)} U\n`;
      } else {
          pasosTexto += `   Ajuste por comida Normal: +0 U\n`;
      }

      // Ajuste por deporte antes de la comida
      let ajusteDeporteAntesFinal = 0;
      if (deporteAntes === 'si') {
          ajusteDeporteAntesFinal = -ajusteDeporteAntes;
          pasosTexto += `   Ajuste por deporte/trabajo físico ANTES: ${ajusteDeporteAntesFinal.toFixed(1)} U\n`;
      } else {
          pasosTexto += `   Ajuste por deporte/trabajo físico ANTES (No): +0 U\n`;
      }
      
      // Ajuste por deporte después de la comida
      let ajusteDeporteDespuesFinal = 0;
      if (deporteDespues === 'si') {
          ajusteDeporteDespuesFinal = -ajusteDeporteDespues;
          pasosTexto += `   Ajuste por deporte/trabajo físico DESPUÉS: ${ajusteDeporteDespuesFinal.toFixed(1)} U\n`;
      } else {
          pasosTexto += `   Ajuste por deporte/trabajo físico DESPUÉS (No tiene previsto): +0 U\n`;
      }

      let totalAjustes = ajusteComida + ajusteDeporteAntesFinal + ajusteDeporteDespuesFinal;
      pasosTexto += `   Total de Ajustes = ${totalAjustes.toFixed(1)} U\n\n`;
      // 6. Dosis Total de Insulina (antes de ajuste por hipoglucemia)
      let dosisTotal = dosisCorreccion + dosisHabitual + totalAjustes;
      pasosTexto += `6. Dosis Total de Insulina (antes de ajuste por hipoglucemia):\n`;
      pasosTexto += `   Dosis Total = DC + Dosis Habitual + Total Ajustes\n`;
      pasosTexto += `   Dosis Total = ${dosisCorreccion.toFixed(1)} U (Corrección) + ${dosisHabitual.toFixed(1)} U (Dosis Habitual) + ${totalAjustes.toFixed(1)} U (Ajustes) = ${dosisTotal.toFixed(1)} U\n\n`;
      // 7. Ajuste por hipoglucemia del día anterior
      if (hipoglucemiaAyer === 'si') {
          const dosisOriginal = dosisTotal;
          const ajusteCalculado = dosisTotal * 0.10;
          let ajusteAplicado;
          if (ajusteCalculado < 1 && dosisOriginal > 0) {
              ajusteAplicado = 1;
              dosisTotal = dosisOriginal - ajusteAplicado;
              pasosTexto += `7. Ajuste por hipoglucemia de ayer:\n`;
              pasosTexto += `   Dosis Original: ${dosisOriginal.toFixed(1)} U\n`;
              pasosTexto += `   El 10% de ajuste (${ajusteCalculado.toFixed(1)} U) es menor a 1 unidad.
 Se aplicará un ajuste mínimo de 1.0 U.\n`;
              pasosTexto += `   Dosis con ajuste: ${dosisTotal.toFixed(1)} U\n`;
          } else {
              dosisTotal *= 0.90;
              // Reducir en un 10%
              pasosTexto += `7.
 Ajuste por hipoglucemia de ayer:\n`;
              pasosTexto += `   Dosis Original: ${dosisOriginal.toFixed(1)} U\n`;
              pasosTexto += `   Ajuste por Hipoglucemia (-10%): ${dosisOriginal.toFixed(1)} * 0.90 = ${dosisTotal.toFixed(1)} U\n`;
          }
      } else {
          pasosTexto += `7.
 Ajuste por hipoglucemia de ayer (No):\n`;
          pasosTexto += `   Sin ajuste.\n`;
      }

      // Redondeo final y mínimo de 0 unidades
      dosisTotal = roundToHalf(dosisTotal);
      if (dosisTotal < 0) {
          dosisTotal = 0;
          document.getElementById('riesgoHipoglucemiaAviso').style.display = 'block';
          pasosTexto += `\n   Ajuste final: La dosis calculada es negativa, por lo que se ha ajustado al mínimo de 0.0 U para evitar una hipoglucemia.\n`;
      } else {
          document.getElementById('riesgoHipoglucemiaAviso').style.display = 'none';
      }
      
      pasosTexto += `\n   Dosis Total Final redondeada: ${dosisTotal.toFixed(1)} U\n`;
      // Mostrar resultado y pasos
      document.getElementById('resultado').textContent = `Dosis de insulina recomendada: ${dosisTotal.toFixed(1)} Unidades`;
      document.getElementById('pasos').textContent = pasosTexto;
      document.getElementById('pasos').style.display = 'block';

      // New condition for "dosis alta" warning
      if (dosisTotal > (0.60 * rapida)) {
        document.getElementById('dosisAltaAviso').style.display = 'block';
      }
      
      // Lógica para el cuadro de recomendaciones, incluyendo el caso de 0 unidades
      if (dosisTotal === 0) {
        document.getElementById('recomendacionesBox').style.display = 'block';
        document.getElementById('recomendacionesTexto').innerHTML = "<b>NO HACE FALTA ADMINISTRAR INSULINA.</b><br><b>Puede comenzar a comer.</b>";
      } else if (dosisHabitual > 0) {
          document.getElementById('recomendacionesBox').style.display = 'block';
          let recomendacionText = '';
          const insulinaNombre = tipoInsulina.charAt(0).toUpperCase() + tipoInsulina.slice(1);
          // Nueva condición para glucemia > 350 mg/dL
          if (glucemiaActual > 350) {
              recomendacionText = `<b>Atención: Usted tiene ahora una gran hiperglucemia y no está aconsejado comer en este momento porque podría empeorar la situación.</b><br>
                                 <b>1º Administre la dosis de insulina ${insulinaNombre}.</b><br>
     
                              <b>2º Revise cada 5 a 10 minutos su glucemia.
 Es importante controlar su nivel de glucemia.</b><br>
                                 <b>3º Solo cuando su glucemia descienda por debajo de 300 mg/dl, podrá comenzar a comer.</b>`;
          } else {
              // Lógica para recomendaciones de insulina existentes (Novorapid, Apidra, Humalog, Fiasp, etc.)
              if (comidaComposicion !== 'pesada') {
                  if (tipoInsulina === 'Novorapid' || tipoInsulina === 'Apidra' || tipoInsulina === 'Humalog') {
                      if (gp15 > 
 200) {
                          recomendacionText = `<b>1º Administre la dosis de insulina ${insulinaNombre}.</b><br><b>2º Espere 20 minutos.</b><br><b>3º Puede comenzar a comer después.</b>`;
                      } else if (gp15 >= 100 && gp15 <= 199) {
                          recomendacionText = `<b>1º Administre la dosis de insulina ${insulinaNombre}.</b><br><b>2º Espere 15 minutos.</b><br><b>3º Puede comenzar a comer después.</b>`;
                      } else if (gp15 >= 70 && gp15 <= 99) {
                          recomendacionText = `<b>1º Administre la dosis de insulina ${insulinaNombre}.</b><br><b>2º NO ESPERE.</b><br><b>3º Puede comenzar a comer.</b>`;
                      } else if (gp15 >= 50 && gp15 <= 69) {
                          recomendacionText = `<b>HAY RIESGO DE GRAVE HIPOGLUCEMIA, NO DEBE ESPERAR:</b><br><b>1º Tome un poco de zumo (si aun no lo ha hecho), o comience tomando el postre.</b><br><b>2º Tome el resto de la comida.</b><br><b>3º Después, administre la dosis de insulina ${insulinaNombre}.</b>`;
                      } else if (gp15 < 50) {
                          recomendacionText = `<b>HAY RIESGO DE GRAVE HIPOGLUCEMIA, NO DEBE ESPERAR:</b><br><b>1º Tome zumo para frenar la hipoglucemia, si aun no lo ha hecho.</b><br><b>2º Puede comenzar a comer.</b><br><b>3º Después, administre la dosis de insulina ${insulinaNombre}.</b>`;
                      }
                  } else if (tipoInsulina === 'Fiasp') {
                      if (gp15 > 200) {
                          recomendacionText = `<b>1º Administre la dosis de insulina Fiasp.</b><br><b>2º Espere 10 minutos.</b><br><b>3º Puede comenzar a comer después.</b>`;
                      } else if (gp15 >= 100 && gp15 <= 199) {
                          recomendacionText = `<b>1º Administre la dosis de insulina Fiasp.</b><br><b>2º Espere 5 minutos.</b><br><b>3º Puede comenzar a comer después.</b>`;
                      } else if (gp15 >= 70 && gp15 <= 99) {
                          recomendacionText = `<b>1º Administre la dosis de insulina Fiasp.</b><br><b>2º NO ESPERE.</b><br><b>3º Puede comenzar a comer.</b>`;
                      } else if (gp15 >= 50 && gp15 <= 69) {
                          recomendacionText = `<b>HAY RIESGO DE GRAVE HIPOGLUCEMIA, NO DEBE ESPERAR:</b><br><b>1º Tome un poco de zumo (si aun no lo ha hecho), o comience tomando el postre.</b><br><b>2º Tome el resto de la comida.</b><br><b>3º Después, administre la dosis de insulina Fiasp.</b>`;
                      } else if (gp15 < 50) {
                          recomendacionText = `<b>HAY RIESGO DE GRAVE HIPOGLUCEMIA, NO DEBE ESPERAR:</b><br><b>1º Tome zumo para frenar la hipoglucemia, si aun no lo ha hecho.</b><br><b>2º Puede comenzar a comer.</b><br><b>3º Después, administre la dosis de insulina Fiasp.</b>`;
                      }
                  }
              } else {
                  // Comida ES pesada
                  if (tipoInsulina === 'Novorapid' || tipoInsulina === 'Apidra' || tipoInsulina === 'Humalog') {
               
                       if (gp15 > 200) {
                          recomendacionText = `<b>1º Administre la dosis de insulina ${insulinaNombre}.</b><br><b>2º Espere 15 minutos.</b><br><b>3º Puede comenzar a comer después.</b>`;
                      } else if (gp15 >= 120 && gp15 <= 199) {
                          recomendacionText = `<b>1º Administre la dosis de insulina ${insulinaNombre}.</b><br><b>2º Espere 5 minutos.</b><br><b>3º Puede comenzar a comer después.</b>`;
                      } else if (gp15 >= 80 && gp15 <= 119) {
                          recomendacionText = `<b>1º Administre la dosis de insulina ${insulinaNombre}.</b><br><b>2º NO ESPERE.</b><br><b>3º Puede comenzar a comer.</b>`;
                      } else if (gp15 >= 69 && gp15 <= 79) {
                          recomendacionText = `<b>LA COMIDA PESADA PUEDE TENER BAJO ÍNDICE GLUCÉMICO, NO DEBE ESPERAR:</b><br><b>1º Comience tomando el postre.</b><br><b>2º Tome el resto de la comida.</b><br><b>3º Después, administre la dosis de insulina ${insulinaNombre}.</b>`;
                      } else if (gp15 < 69) {
                          recomendacionText = `<b>HAY RIESGO DE GRAVE HIPOGLUCEMIA, NO DEBE ESPERAR:</b><br><b>1º Tome zumo para frenar la hipoglucemia, si aun no lo ha hecho.</b><br><b>2º Puede comenzar a comer.</b><br><b>3º Después, administre la dosis de insulina ${insulinaNombre}.</b>`;
                      }
                  } else if (tipoInsulina === 'Fiasp') {
                      if (gp15 > 180) {
                          recomendacionText = `<b>1º Administre la dosis de insulina ${insulinaNombre}.</b><br><b>2º Espere 5 minutos.</b><br><b>3º Puede comenzar a comer después.</b>`;
                      } else if (gp15 >= 100 && gp15 <= 179) {
                          recomendacionText = `<b>1º Administre la dosis de insulina ${insulinaNombre}.</b><br><b>2º NO ESPERE.</b><br><b>3º Puede comenzar a comer.</b>`;
                      } else if (gp15 >= 69 && gp15 <= 99) {
                          recomendacionText = `<b>LA COMIDA PESADA PUEDE TENER BAJO ÍNDICE GLUCÉMICO, NO DEBE ESPERAR:</b><br><b>1º Comience tomando el postre.</b><br><b>2º Tome el resto de la comida.</b><br><b>3º Después, administre la dosis de insulina ${insulinaNombre}.</b>`;
                      } else if (gp15 < 69) {
                          recomendacionText = `<b>HAY RIESGO DE GRAVE HIPOGLUCEMIA, NO DEBE ESPERAR:</b><br><b>1º Tome zumo para frenar la hipoglucemia, si aun no lo ha hecho.</b><br><b>2º Puede comenzar a comer.</b><br><b>3º Después, administre la dosis de insulina ${insulinaNombre}.</b>`;
                      }
                  }
              }
          }
          document.getElementById('recomendacionesTexto').innerHTML = recomendacionText;
      }
    }

    // Inicializar el estado de los contenedores al cargar la página
    document.addEventListener('DOMContentLoaded', (event) => {
        // Ajustar step para dosis habitual (1 decimal)
        document.getElementById('dosisHabitualComidaActual').step = "0.1";
    });
    </script>

</body>
</html>