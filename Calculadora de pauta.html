<!DOCTYPE html>
<html lang="es">
<head>
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-W3GTQQL7');</script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calculadora Dosis de Insulina - Hospital Universitario La Merced</title>
  <style>
    /* Reset básico para asegurar box-sizing */
    *, *::before, *::after {
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 1rem auto;
      padding: 0 1rem;
      background-image: url('Imagen de fondo presentación.png'); /* IMAGEN DE FONDO */
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      background-color: #f9f9f9;
      color: #333;
      font-size: 1em;
    }
    h1, h2 {
      color: #008000;
      font-size: 1.8em;
      margin-top: 1.5rem;
      margin-bottom: 0.8rem;
    }
    h1 {
      text-align: center;
      font-size: 2.2em;
    /* This is the size for "Hospital Universitario La Merced" */
    }
    .hospital-info {
      text-align: center;
      margin-bottom: 1.5rem;
    }
    .hospital-info h2 {
        font-size: 1.5em;
        margin-bottom: 0.2em;
        color: #008000;
        /* Verde oscuro similar al logo */
    }
    .hospital-info p {
        font-size: 0.9em;
        color: #555;
        margin-top: 0;
    }
    .main-title {
        text-align: center;
        font-size: 3.6em; /* Doble de 1.8em */
        color: #008000;
        /* Verde oscuro */
        font-weight: bold;
        margin-top: 1rem;
        margin-bottom: 1.5rem;
    }
    label {
      font-weight: bold;
      display: block;
      margin-top: 1em;
    }
    input[type=number], select {
      width: 100%;
      max-width: 200px; /* Incrementado para mejor pulsación en móvil */
      padding: 0.5em;
      margin-top: 0.2em;
      margin-bottom: 0.6em;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1em;
      /* Asegura que el texto dentro del input no sea muy pequeño */
    }
    .checkbox-inline {
      display: inline-block;
      margin-right: 1.5em;
      font-size: 1em;
      /* Asegura que el texto de la checkbox sea legible */
    }
    .checkbox-inline input {
      margin-right: 0.5em;
      /* Espacio entre checkbox y texto */
      vertical-align: middle;
      /* Alinea el checkbox con el texto */
    }
    #datosAyerContainer, #correccionRatioContainerAvanzado {
      background: #e6ffe6;
      /* Verde muy claro */
      border: 1px solid #99e699;
      /* Verde más fuerte */
      padding: 1em;
      margin-top: 0.8em;
      border-radius: 6px;
    }
    button {
      margin-top: 1.2em;
      padding: 0.7em 1.2em;
      background-color: #008000;
      /* Verde oscuro */
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 1.1em;
      /* Un poco más grande para facilitar la pulsación */
      cursor: pointer;
      width: auto;
      /* Ancho automático, no 100% */
      display: block;
      /* Para que ocupe su propia línea si es necesario */
    }
    button:hover {
      background-color: #005500;
      /* Verde más oscuro al pasar el ratón */
    }
    .resultado {
      margin-top: 1.5em;
      font-size: 1.3em;
      /* Ajustado para mayor visibilidad */
      font-weight: bold;
      color: #004d00;
      /* Verde oscuro para el resultado */
    }
    .resultado-aviso {
        font-size: 0.9em;
        color: #cc0000;
        margin-top: 0.5em;
        font-weight: normal;
    }
    .resultado-aviso.alerta-correccion {
        color: orange;
        /* Color diferente para aviso de corrección alta */
    }
    pre.pasos {
      background: #e6ffe6;
      /* Verde muy claro */
      border: 1px solid #99e699;
      /* Verde más fuerte */
      padding: 1em;
      white-space: pre-wrap;
      margin-top: 1em;
      border-radius: 6px;
      font-size: 0.9em;
      /* Para que los pasos no sean demasiado grandes */
      line-height: 1.4;
    }
    .pasos-correccion-ratio, .pasos-calculo-ratio-basico {
        background: #e6ffe6;
        /* Verde muy claro */
        border: 1px solid #99e699;
        /* Verde más fuerte */
        padding: 1em;
        white-space: pre-wrap;
        margin-top: 1em;
        border-radius: 6px;
        font-size: 0.85em;
        line-height: 1.4;
    }
    .error-message {
      color: red;
      font-size: 0.85em;
      /* Un poco más pequeña pero legible */
      margin-top: -0.4em;
      margin-bottom: 0.4em;
      display: none;
    }
    .logo-container {
        text-align: center;
        margin-bottom: 1.5rem;
    }
    .logo-container img {
        max-width: 400px;
        /* Tamaño por defecto para PC */
        height: auto;
        display: block;
        /* Asegura que ocupe su propio espacio y se centra */
        margin: 0 auto;
        /* Centra la imagen */
    }
    .disclaimer-text p {
        margin-bottom: 0.5em;
        /* Espacio entre párrafos para "puntos y aparte" */
    }
    .aviso-extra {
        font-size: 0.95em;
        color: #555;
        margin-top: 1em;
        line-height: 1.4;
    }
    .mensaje-rojo {
        color: red;
        font-weight: bold;
        margin-top: 0.8em;
    }
    /* Estilo para el mensaje de corrección alta en rojo y negrita */
    #correccionAltaAviso {
        color: red;
        font-weight: bold;
    }
    .input-error {
        border-color: red !important;
    }

    /* Media Queries para pantallas pequeñas (smartphones) */
    @media (max-width: 600px) {
      body {
        font-size: 1.1em;
        /* Aumenta el tamaño base para mayor legibilidad en móviles */
        padding: 0 0.8rem;
      }
      h1 {
        font-size: 1.8em;
      }
      h2 {
        font-size: 1.4em;
      }
      label, input[type=number], select { /* Aplicar a label y select también */
        font-size: 1.1em;
        /* Unificar tamaño de fuente para inputs y labels en móvil */
      }
      input[type=number], select {
        max-width: 100%;
        /* Ocupa todo el ancho disponible */
        padding: 0.6em;
      }
      button {
        font-size: 1.1em;
        width: 100%;
        /* Botones de ancho completo en móvil */
        padding: 0.8em 1em;
      }
      .resultado {
        font-size: 1.2em;
      }
      pre.pasos, .pasos-correccion-ratio, .pasos-calculo-ratio-basico {
        font-size: 0.95em;
      }
      .checkbox-inline {
        display: block;
        /* Checkboxes en líneas separadas para facilitar la interacción */
        margin-right: 0;
        margin-bottom: 0.5em;
      }
      .logo-container img {
        max-width: 150px;
        /* Tamaño más pequeño para móviles */
      }
  </style>
</head>
<body>
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-W3GTQQL7"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <div class="logo-container">
    <img src="COLOR_3_TINTAS.jpg" alt="Logo Área de Gestión Sanitaria de Osuna" />
  </div>

  <div class="hospital-info">
    <h1>Hospital Universitario La Merced</h1>
    <h2>Consulta de Diabetes</h2>
    <p>Francisco José Osuna Navarro</p>
    <br/> <p class="main-title">CALCULADORA DE PAUTA DE INSULINA RÁPIDA</p>
  </div>

  <div class="disclaimer-text">
    <p>Esta herramienta tiene como objetivo ayudar para el cálculo de la dosis de insulina rápida a administrar, simplificando operaciones complejas y ayudando al paciente
a aplicar lo aprendido durante su Educación Terapéutica en Diabetes.</p>
    <p>El uso correcto de esta calculadora parte del conocimiento adquirido en consulta y debe formar parte de una estrategia de autocuidado supervisada.</p>
  </div>

  <hr>

  <p><strong>Edición en pruebas.
Versión 1a.</strong></p>

  <h2>1. Insulina y glucemia</h2>

  <label for="rapida">Unidades totales de insulina rápida diaria (de media en los últimos 2 días):</label>
  <input id="rapida" type="number" min="0" step="0.1" />
  <span class="error-message" id="errorRapida">Introduce un valor válido y no negativo.</span>

  <label for="lenta">Unidades totales de insulina lenta diaria (de media en los últimos 2 días):</label>
  <input id="lenta" type="number" min="0" step="0.1" />
  <span class="error-message" id="errorLenta">Introduce un valor válido y no negativo.</span>

  <label for="constanteCorreccion">Constante de corrección: Por defecto 1800. (Puede modificarse en personas muy sensibles a correcciones o frágiles).</label>
  <input id="constanteCorreccion" type="number" min="1" step="1" value="1800" />
  <span class="error-message"
id="errorConstanteCorreccion">Introduce un valor válido y mayor que cero.</span>

  <hr>

  <h2>2. Glucemia y Raciones</h2>

  <label for="glucemiaActual">Glucemia ANTERIOR a esta comida (mg/dL):</label>
  <input id="glucemiaActual" type="number" min="0" step="1" />
  <span class="error-message" id="errorGlucemiaActual">Introduce un valor válido y no negativo.</span>

  <label for="glucemiaObjetivo">Glucemia objetivo dentro de 3 horas (mg/dL) (Por defecto 120).
Por la noche, o en pacientes muy sensibles o con fragilidad, puede indicarse 150 o un valor mayor):</label>
  <input id="glucemiaObjetivo" type="number" min="0" step="1" value="120" />
  <span class="error-message" id="errorGlucemiaObjetivo">Introduce un valor válido y no negativo.</span>

  <label for="racionesComidaActual">Raciones de hidratos de carbono de esta comida:</label>
  <input id="racionesComidaActual" type="number" min="0" step="0.5" />
  <span class="error-message" id="errorRacionesComidaActual">Introduce un valor válido y no negativo.</span>
  <p class="resultado-aviso" id="avisoRacionesCero" style="display:none;">⚠️ Has indicado raciones 0 pero tienes ratio mayor que 0. ¿Estás seguro?</p>

  <div class="checkbox-inline">
    <input type="checkbox" id="noConozcoRatio" onchange="toggleRatioInput()"> No conozco mi Ratio
  </div>
  <div class="checkbox-inline">
    <input type="checkbox" id="necesitoCorregirRatioMedio" onchange="toggleRatioInput()"> Necesito corregir mi Ratio medio
  </div>
  <br>

  <label for="ratioInput">Ratio actual de hidratos de carbono (ración/unidad de insulina):</label>
  <input id="ratioInput" type="number" min="0.1" step="0.1" value="" />
  <span class="error-message" id="errorRatio">Introduce un valor válido y mayor que cero.</span>
  <p class="resultado-aviso" id="avisoRatioCero" style="display:none;">⚠️ Has indicado un ratio 0. ¿Estás seguro?</p>
  <pre class="pasos-calculo-ratio-basico" id="pasosCalculoRatioBasico" style="display:none;"></pre>

  <hr>

  <h2>3. Otros ajustes</h2>

  <label for="flechaGlucemia">Si tiene Monitorización, indica cómo está la flecha:</label>
  <select id="flechaGlucemia">
    <option value="estable">Estable</option>
    <option value="ascenso_lento">Ascenso lento</option>
    <option value="ascenso_rapido">Ascenso rápido</option>
    <option value="descenso_lento">Descenso lento</option>
    <option value="descenso_rapido">Descenso rápido</option>
  </select>

  <label for="deporteAntes">¿Hizo deporte/trabajo físico antes de esta comida?</label>
  <select id="deporteAntes">
    <option value="0" selected>No hizo</option>
    <option value="-0.10">Poco (resta el 10% de la dosis de insulina rápida)</option>
    <option value="-0.20">Mucho (resta el 20% de la dosis de insulina rápida)</option>
  </select>

  <label for="deporteDespues">¿Va a hacer deporte/trabajo físico después de esta comida?</label>
  <select id="deporteDespues">
    <option value="0" selected>No tiene previsto</option>
    <option value="-0.05">Poco (resta el 5% de la dosis de insulina rápida)</option>
    <option value="-0.10">Mucho (resta el 10% de la dosis de insulina rápida)</option>
  </select>

  <label for="hipoglucemiaAyer">¿Ayer tuvo usted hipoglucemia después de esta comida?:</label>
  <select id="hipoglucemiaAyer">
    <option value="no" selected>No</option>
    <option value="si">Sí</option>
  </select>

  <hr>

  <h2>4. Cálculo</h2>
  <button onclick="calcularInsulina()">Calcular pauta de insulina</button>

  <div class="resultado" id="resultadoPautaReal">Pauta de insulina real: <span id="valorPautaReal">0 Unidades</span></div>
  <div class="resultado" id="resultadoPautaRecomendada">Pauta de insulina recomendada: <span id="valorPautaRecomendada">0 Unidades</span></div>

  <p class="resultado-aviso" id="dosisAltaAviso" style="display:none;">⚠️ Esta es una pauta alta.
Por favor, revise los datos introducidos y/o consulte con su profesional sanitario.</p>
  <p class="resultado-aviso" id="correccionAltaAviso" style="display:none;">⚠️ Dosis de corrección alta ¿Está seguro?</p>
  <p class="resultado-aviso" id="avisoRatioAlto" style="display:none;">⚠️ Atención: tu nuevo Ratio es muy alto. Por favor, revisa tus datos.</p>
  <p class="resultado-aviso" id="avisoRatioBajo" style="display:none;">⚠️ Atención: tu nuevo Ratio es muy bajo. Por favor, revisa tus datos.</p>

  <p class="mensaje-rojo" id="riesgoHipoglucemiaAviso" style="display:none;">⚠️ Riesgo de hipoglucemia. Revise los datos introducidos. Puede que tenga que comer más hidratos de carbono en esta comida</p>
  <p style="color: black; font-weight: bold;">Los resultados ofrecidos son únicamente orientativos y no sustituyen la consulta ni las indicaciones de su profesional sanitario.</p>
  <p class="aviso-extra">Puede que esta dosis de insulina necesite algún ajuste extra como es el caso de situaciones por enfermedad (fiebre, diarrea,...), algunos tratamientos (corticoides,...), menstruación,... que pueden hacer variar estos cálculos.
Consulta con tu profesional.</p>
  <pre class="pasos" id="pasos"></pre>

  <script>
    // Función genérica para validar input y mostrar mensaje de error
    function validateInput(inputId, errorId, condition) {
      const input = document.getElementById(inputId);
      const errorSpan = document.getElementById(errorId);
      if (!condition(input.value)) {
        input.classList.add('input-error');
        errorSpan.style.display = 'block';
        return false;
      } else {
        input.classList.remove('input-error');
        errorSpan.style.display = 'none';
        return true;
      }
    }

    // Funciones de validación específicas
    const isPositiveNumber = (value) => parseFloat(value) > 0;
    const isNonNegativeNumber = (value) => parseFloat(value) >= 0;

    // Redondeo a la media unidad más cercana
    function roundToHalf(num) {
        return Math.round(num * 2) / 2;
    }

    // Función para manejar la visibilidad y validación del Ratio
    function toggleRatioInput() {
      const noConozcoRatio = document.getElementById('noConozcoRatio').checked;
      const necesitoCorregirRatioMedio = document.getElementById('necesitoCorregirRatioMedio').checked;
      const ratioInput = document.getElementById('ratioInput');
      const errorRatio = document.getElementById('errorRatio');
      const avisoRatioCero = document.getElementById('avisoRatioCero');
      const pasosCalculoRatioBasico = document.getElementById('pasosCalculoRatioBasico');

      if (noConozcoRatio || necesitoCorregirRatioMedio) {
        ratioInput.value = ''; // Clear the input when checkbox is checked
        ratioInput.disabled = true;
        errorRatio.style.display = 'none'; // Hide error if disabled
        avisoRatioCero.style.display = 'none'; // Hide specific warning if disabled
      } else {
        ratioInput.disabled = false;
        // Re-validate if it's not disabled, and has a value
        if (ratioInput.value !== '') {
            validateInput('ratioInput', 'errorRatio', isPositiveNumber);
            if (parseFloat(ratioInput.value) === 0) {
                avisoRatioCero.style.display = 'block';
            }
        }
      }

      if (necesitoCorregirRatioMedio) {
          pasosCalculoRatioBasico.style.display = 'block';
      } else {
          pasosCalculoRatioBasico.style.display = 'none';
      }
    }

    // Función principal para calcular la dosis de insulina
    function calcularInsulina() {
      const rapida = parseFloat(document.getElementById('rapida').value);
      const lenta = parseFloat(document.getElementById('lenta').value);
      const constanteCorreccion = parseFloat(document.getElementById('constanteCorreccion').value);
      let glucemiaActual = parseFloat(document.getElementById('glucemiaActual').value);
      const glucemiaObjetivo = parseFloat(document.getElementById('glucemiaObjetivo').value);
      const racionesComidaActual = parseFloat(document.getElementById('racionesComidaActual').value);
      let ratio = parseFloat(document.getElementById('ratioInput').value); // Use let for ratio

      const flechaGlucemia = document.getElementById('flechaGlucemia').value;
      const deporteAntes = parseFloat(document.getElementById('deporteAntes').value);
      const deporteDespues = parseFloat(document.getElementById('deporteDespues').value);
      const hipoglucemiaAyer = document.getElementById('hipoglucemiaAyer').value;

      const noConozcoRatio = document.getElementById('noConozcoRatio').checked;
      const necesitoCorregirRatioMedio = document.getElementById('necesitoCorregirRatioMedio').checked;

      // Resetear mensajes de aviso
      document.getElementById('dosisAltaAviso').style.display = 'none';
      document.getElementById('correccionAltaAviso').style.display = 'none';
      document.getElementById('riesgoHipoglucemiaAviso').style.display = 'none';
      document.getElementById('avisoRatioAlto').style.display = 'none';
      document.getElementById('avisoRatioBajo').style.display = 'none';
      document.getElementById('avisoRacionesCero').style.display = 'none';
      document.getElementById('avisoRatioCero').style.display = 'none';

      // Validaciones iniciales para todos los campos principales
      let valid = true;
      valid = validateInput('rapida', 'errorRapida', isNonNegativeNumber) && valid;
      valid = validateInput('lenta', 'errorLenta', isNonNegativeNumber) && valid;
      valid = validateInput('constanteCorreccion', 'errorConstanteCorreccion', isPositiveNumber) && valid;
      valid = validateInput('glucemiaActual', 'errorGlucemiaActual', isNonNegativeNumber) && valid;
      valid = validateInput('glucemiaObjetivo', 'errorGlucemiaObjetivo', isNonNegativeNumber) && valid;
      valid = validateInput('racionesComidaActual', 'errorRacionesComidaActual', isNonNegativeNumber) && valid;

      if (!noConozcoRatio && !necesitoCorregirRatioMedio) {
          valid = validateInput('ratioInput', 'errorRatio', isPositiveNumber) && valid;
          if (parseFloat(document.getElementById('ratioInput').value) === 0) {
              document.getElementById('avisoRatioCero').style.display = 'block';
          }
      }

      // Special check for racionesComidaActual and ratioInput if ratio is not zero
      if (racionesComidaActual === 0 && !noConozcoRatio && !necesitoCorregirRatioMedio && ratio > 0) {
          document.getElementById('avisoRacionesCero').style.display = 'block';
      }


      if (!valid) {
        document.getElementById('valorPautaReal').textContent = 'Error: Por favor, corrige los errores marcados.';
        document.getElementById('valorPautaRecomendada').textContent = '';
        document.getElementById('pasos').textContent = '';
        return;
      }

      const totalInsulinaDiaria = rapida + lenta;
      let fsi = 0;
      if (totalInsulinaDiaria > 0) {
        fsi = constanteCorreccion / totalInsulinaDiaria;
      } else {
        document.getElementById('valorPautaReal').textContent = 'Error: La suma de insulina rápida y lenta no puede ser cero para calcular el FSI.';
        document.getElementById('valorPautaRecomendada').textContent = '';
        document.getElementById('pasos').textContent = '';
        return;
      }

      let pasosTexto = `Pasos del cálculo:\n\n`;

      // Adjustment of glucemiaActual based on flechaGlucemia
      const originalGlucemiaActual = glucemiaActual;
      let ajusteGlucemiaFlecha = 0;
      pasosTexto += `1. Ajuste de Glucemia actual según la flecha del Monitorización:\n`;
      pasosTexto += `   Glucemia actual inicial: ${originalGlucemiaActual} mg/dL\n`;
      switch (flechaGlucemia) {
        case 'ascenso_lento':
          ajusteGlucemiaFlecha = 25;
          pasosTexto += `   Flecha (Ascenso lento): Glucemia actual + 25 mg/dL\n`;
          break;
        case 'ascenso_rapido':
          ajusteGlucemiaFlecha = 50;
          pasosTexto += `   Flecha (Ascenso rápido): Glucemia actual + 50 mg/dL\n`;
          break;
        case 'descenso_lento':
          ajusteGlucemiaFlecha = -25;
          pasosTexto += `   Flecha (Descenso lento): Glucemia actual - 25 mg/dL\n`;
          break;
        case 'descenso_rapido':
          ajusteGlucemiaFlecha = -50;
          pasosTexto += `   Flecha (Descenso rápido): Glucemia actual - 50 mg/dL\n`;
          break;
        case 'estable':
        default:
          ajusteGlucemiaFlecha = 0;
          pasosTexto += `   Flecha (Estable): Glucemia actual + 0 mg/dL\n`;
          break;
      }
      glucemiaActual += ajusteGlucemiaFlecha;
      pasosTexto += `   Glucemia actual ajustada: ${glucemiaActual.toFixed(1)} mg/dL\n\n`;

      // 2. Cálculo de la Dosis de Corrección (DC)
      let dosisCorreccion = 0;
      let diferenciaGlucemia = glucemiaActual - glucemiaObjetivo;
      pasosTexto += `2. Cálculo de la Dosis de Corrección (DC):\n`;
      pasosTexto += `   Glucemia ajustada: ${glucemiaActual.toFixed(1)} mg/dL\n`;
      pasosTexto += `   Glucemia objetivo: ${glucemiaObjetivo} mg/dL\n`;
      pasosTexto += `   Diferencia de Glucemia = Glucemia ajustada - Glucemia objetivo = ${glucemiaActual.toFixed(1)} - ${glucemiaObjetivo} = ${diferenciaGlucemia.toFixed(1)} mg/dL\n`;
      pasosTexto += `   Factor de Sensibilidad a la Insulina (FSI) = Constante de Corrección / (Insulina Rápida + Lenta) = ${constanteCorreccion} / (${rapida} + ${lenta}) = ${fsi.toFixed(2)}\n`;
      if (diferenciaGlucemia !== 0) {
        dosisCorreccion = roundToHalf(diferenciaGlucemia / fsi);
        pasosTexto += `   Dosis de Corrección (DC) = Diferencia de Glucemia / FSI = ${diferenciaGlucemia.toFixed(1)} / ${fsi.toFixed(2)} = ${dosisCorreccion.toFixed(1)} U\n\n`;
        if (Math.abs(dosisCorreccion) > 4 && diferenciaGlucemia >= 0) {
            document.getElementById('correccionAltaAviso').style.display = 'block';
        }
      } else {
        dosisCorreccion = 0;
        pasosTexto += `   Glucemia ajustada (${glucemiaActual.toFixed(1)}) es igual a Glucemia objetivo (${glucemiaObjetivo}). No se requiere dosis de corrección (DC = 0 U).\n\n`;
      }

      // 3. Cálculo de la Dosis de Hidratos de Carbono (DHC) y/o Ratio
      let dosisHidratosCarbono = 0;
      pasosTexto += `3. Cálculo de la Dosis de Hidratos de Carbono (DHC) y ajuste del Ratio:\n`;

      if (noConozcoRatio) {
          ratio = totalInsulinaDiaria / 10; // Assuming 10 is a general constant for this calculation
          pasosTexto += `   No conoces tu Ratio. Se calculará un Ratio estimado = (Insulina Rápida + Lenta) / 10 = (${rapida} + ${lenta}) / 10 = ${ratio.toFixed(1)}\n`;
          document.getElementById('pasosCalculoRatioBasico').style.display = 'block';
          document.getElementById('pasosCalculoRatioBasico').textContent = `Cálculo del Ratio estimado (si no se conoce):
Ratio = (Insulina Rápida diaria + Insulina Lenta diaria) / 10
Ratio = (${rapida.toFixed(1)} U + ${lenta.toFixed(1)} U) / 10 = ${totalInsulinaDiaria.toFixed(1)} / 10 = ${ratio.toFixed(1)}`;
      } else if (necesitoCorregirRatioMedio) {
          const ratioActualTemp = ratio; // Store the input ratio for display
          if (totalInsulinaDiaria > 0 && racionesComidaActual > 0) {
              ratio = totalInsulinaDiaria / 10; // Re-calculate based on total daily insulin
              pasosTexto += `   Necesitas corregir tu Ratio medio. El Ratio se calculará como: (Insulina Rápida diaria + Insulina Lenta diaria) / 10 = (${rapida} + ${lenta}) / 10 = ${ratio.toFixed(1)}\n`;
              document.getElementById('pasosCalculoRatioBasico').style.display = 'block';
              document.getElementById('pasosCalculoRatioBasico').textContent = `Cálculo del nuevo Ratio medio (si se necesita corregir):
Ratio = (Insulina Rápida diaria + Insulina Lenta diaria) / 10
Ratio = (${rapida.toFixed(1)} U + ${lenta.toFixed(1)} U) / 10 = ${totalInsulinaDiaria.toFixed(1)} / 10 = ${ratio.toFixed(1)}`;
          } else {
              pasosTexto += `   No se puede calcular el Ratio medio si la insulina total diaria o las raciones de comida son cero. Se usará el Ratio introducido: ${ratio.toFixed(1)}\n`;
              document.getElementById('pasosCalculoRatioBasico').textContent = `No se puede calcular el Ratio medio si la insulina total diaria o las raciones de comida son cero. Se usará el Ratio introducido: ${ratio.toFixed(1)}`;
          }
      } else {
          pasosTexto += `   Ratio introducido: ${ratio.toFixed(1)}\n`;
      }

      if (ratio <= 0) { // Should be caught by validation but as a safeguard
          document.getElementById('valorPautaReal').textContent = 'Error: El Ratio no puede ser cero o negativo para el cálculo de DHC.';
          document.getElementById('valorPautaRecomendada').textContent = '';
          document.getElementById('pasos').textContent = '';
          return;
      }
      dosisHidratosCarbono = roundToHalf(racionesComidaActual / ratio);
      pasosTexto += `   Dosis de Hidratos de Carbono (DHC) = Raciones de esta comida / Ratio = ${racionesComidaActual} / ${ratio.toFixed(1)} = ${dosisHidratosCarbono.toFixed(1)} U\n\n`;

      // 4. Ajustes por Actividad Física y Hipoglucemia
      let ajusteDeporteAntes = 0;
      let ajusteDeporteDespues = 0;
      let ajusteHipoglucemiaAyer = 0;

      pasosTexto += `4. Ajustes adicionales:\n`;
      if (deporteAntes === -0.10) {
        ajusteDeporteAntes = -0.10 * dosisHidratosCarbono; // Apply to DHC
        pasosTexto += `   Deporte/trabajo físico ANTES de esta comida (Poco): -10% de la DHC (${dosisHidratosCarbono.toFixed(1)} U) = ${ajusteDeporteAntes.toFixed(1)} U\n`;
      } else if (deporteAntes === -0.20) {
        ajusteDeporteAntes = -0.20 * dosisHidratosCarbono; // Apply to DHC
        pasosTexto += `   Deporte/trabajo físico ANTES de esta comida (Mucho): -20% de la DHC (${dosisHidratosCarbono.toFixed(1)} U) = ${ajusteDeporteAntes.toFixed(1)} U\n`;
      } else {
        ajusteDeporteAntes = 0;
        pasosTexto += `   Deporte/trabajo físico ANTES de esta comida (No hizo): +0 U\n`;
      }

      if (deporteDespues === -0.05) {
        ajusteDeporteDespues = -0.05 * dosisHidratosCarbono; // Apply to DHC
        pasosTexto += `   Deporte/trabajo físico DESPUÉS de esta comida (Poco): -5% de la DHC (${dosisHidratosCarbono.toFixed(1)} U) = ${ajusteDeporteDespues.toFixed(1)} U\n`;
      } else if (deporteDespues === -0.10) {
        ajusteDeporteDespues = -0.10 * dosisHidratosCarbono; // Apply to DHC
        pasosTexto += `   Deporte/trabajo físico DESPUÉS de esta comida (Mucho): -10% de la DHC (${dosisHidratosCarbono.toFixed(1)} U) = ${ajusteDeporteDespues.toFixed(1)} U\n`;
      } else {
        ajusteDeporteDespues = 0;
        pasosTexto += `   Deporte/trabajo físico DESPUÉS de esta comida (No tiene previsto): +0 U\n`;
      }

      if (hipoglucemiaAyer === 'si') {
        ajusteHipoglucemiaAyer = -0.10 * dosisHidratosCarbono; // Apply to DHC
        pasosTexto += `   ¿Ayer tuvo usted hipoglucemia después de esta comida? (Sí): -10% de la DHC (${dosisHidratosCarbono.toFixed(1)} U) = ${ajusteHipoglucemiaAyer.toFixed(1)} U\n`;
      } else {
        ajusteHipoglucemiaAyer = 0;
        pasosTexto += `   ¿Ayer tuvo usted hipoglucemia después de esta comida? (No): +0 U\n`;
      }

      let totalAjustes = ajusteDeporteAntes + ajusteDeporteDespues + ajusteHipoglucemiaAyer;
      pasosTexto += `   Total de Ajustes = ${ajusteDeporteAntes.toFixed(1)} + ${ajusteDeporteDespues.toFixed(1)} + ${ajusteHipoglucemiaAyer.toFixed(1)} = ${totalAjustes.toFixed(1)} U\n\n`;

      // 5. Cálculo de la Pauta Real y Recomendada
      let pautaTotalReal = dosisCorreccion + dosisHidratosCarbono + totalAjustes;
      pautaTotalReal = roundToHalf(pautaTotalReal);

      if (pautaTotalReal < 0) {
          pautaTotalReal = 0;
          document.getElementById('riesgoHipoglucemiaAviso').style.display = 'block';
      } else {
          document.getElementById('riesgoHipoglucemiaAviso').style.display = 'none';
      }

      // Check for extremely high or low ratio and show warning
      const currentRatioInputVal = parseFloat(document.getElementById('ratioInput').value);

      if ((!noConozcoRatio && !necesitoCorregirRatioMedio && racionesComidaActual > 0 && currentRatioInputVal > 0) ||
          ((noConozcoRatio || necesitoCorregirRatioMedio) && totalInsulinaDiaria > 0)) {

          const ratioForWarning = (noConozcoRatio || necesitoCorregirRatioMedio) ? ratio : currentRatioInputVal;

          if (ratioForWarning < 5) {
              document.getElementById('avisoRatioBajo').style.display = 'block';
          } else if (ratioForWarning > 30) {
              document.getElementById('avisoRatioAlto').style.display = 'block';
          }
      }


      pasosTexto += `5. Pauta de insulina real:\n`;
      pasosTexto += `   Pauta Total Real = DC + DHC + Total Ajustes\n`;
      pasosTexto += `   Pauta Total Real = ${dosisCorreccion.toFixed(1)} U (Corrección) + ${dosisHidratosCarbono.toFixed(1)} U (DHC) + ${totalAjustes.toFixed(1)} U (Ajustes) = ${pautaTotalReal.toFixed(1)} U\n\n`;

      // Calculate Pauta Recomendada (average of Pauta Habitual and Pauta Total Real)
      // For this calculator, "pauta habitual" is not an input, but rather the result of DHC.
      // Assuming "pauta habitual" in this context refers to DHC before adjustments.
      // However, given the context of the previous "basic calculator" this might be a misinterpretation.
      // Let's re-evaluate "Pauta Habitual" from the previous context.
      // In the "basic" calculator, "dosisHabitualComidaActual" was an input.
      // In this "pauta" calculator, there's no direct "dosisHabitualComidaActual" input for averaging.
      // The instruction for "Pauta Recomendada" is "(average of Pauta Habitual and Pauta Total Real)".
      // Given the structure, if "noConozcoRatio" or "necesitoCorregirRatioMedio" is checked, the ratio is calculated.
      // If not, the ratio is input.
      // The most logical "Pauta Habitual" for this context would be the DHC *before* any adjustments, i.e. racionesComidaActual / ratio.

      const pautaHabitual = roundToHalf(racionesComidaActual / ratio); // Re-calculate based on calculated/entered ratio
      const pautaRecomendada = roundToHalf((pautaHabitual + pautaTotalReal) / 2);

      pasosTexto += `6. Pauta de insulina recomendada:\n`;
      pasosTexto += `   Pauta Habitual (basada en raciones y ratio) = Raciones de esta comida / Ratio = ${racionesComidaActual} / ${ratio.toFixed(1)} = ${pautaHabitual.toFixed(1)} U\n`;
      pasosTexto += `   Pauta Recomendada = (Pauta Habitual + Pauta Total Real) / 2 = (${pautaHabitual.toFixed(1)} + ${pautaTotalReal.toFixed(1)}) / 2 = ${pautaRecomendada.toFixed(1)} U\n\n`;

      // Mostrar resultado y pasos
      document.getElementById('valorPautaReal').textContent = `${pautaTotalReal.toFixed(1)} Unidades`;
      document.getElementById('valorPautaRecomendada').textContent = `${pautaRecomendada.toFixed(1)} Unidades`;
      document.getElementById('pasos').textContent = pasosTexto;
      document.getElementById('pasos').style.display = 'block';

      // New condition for "pauta alta" warning
      // The thresholds here need to be re-evaluated for a "pauta" calculator, as "dosisHabitualComidaActual" doesn't exist.
      // Instead, we can use pautaHabitual (calculated DHC) and totalInsulinaDiaria.
      const threshold150pc = 1.5 * pautaHabitual;
      const threshold50pcTotalInsulina = 0.5 * (rapida + lenta);

      if (pautaTotalReal > threshold150pc || pautaTotalReal > threshold50pcTotalInsulina) {
        document.getElementById('dosisAltaAviso').style.display = 'block';
      }
    }

    // Inicializar el estado de los contenedores al cargar la página
    document.addEventListener('DOMContentLoaded', (event) => {
        toggleRatioInput(); // Call on load to set initial state
        const ratioInput = document.getElementById('ratioInput');
        ratioInput.addEventListener('input', () => {
            const noConozcoRatioChecked = document.getElementById('noConozcoRatio').checked;
            const necesitaCorregirRatioMedioChecked = document.getElementById('necesitoCorregirRatioMedio').checked;

            if (!noConozcoRatioChecked && !necesitaCorregirRatioMedioChecked) {
                if (parseFloat(ratioInput.value) === 0) {
                    document.getElementById('avisoRatioCero').style.display = 'block';
                } else {
                    document.getElementById('avisoRatioCero').style.display = 'none';
                }
            } else {
                document.getElementById('avisoRatioCero').style.display = 'none';
            }
        });

        // Event listeners para los cambios en racionesComidaActual para el aviso
        const racionesComidaActualInput = document.getElementById('racionesComidaActual');
        racionesComidaActualInput.addEventListener('input', () => {
            const ratioVal = parseFloat(document.getElementById('ratioInput').value);
            const noConozcoRatioChecked = document.getElementById('noConozcoRatio').checked;
            const necesitaCorregirRatioMedioChecked = document.getElementById('necesitoCorregirRatioMedio').checked;

            let effectiveRatio = ratioVal;
            if (noConozcoRatioChecked || necesitaCorregirRatioMedioChecked) {
                // If checkbox is checked, ratio will be calculated based on total insulin,
                // so we need totalInsulinaDiaria to check for the warning.
                // For simplicity here, we'll assume a calculated ratio might still be >0.
                // This warning logic needs to be careful not to trigger if ratio *is* effectively 0.
                const rapida = parseFloat(document.getElementById('rapida').value);
                const lenta = parseFloat(document.getElementById('lenta').value);
                const totalInsulinaDiaria = rapida + lenta;
                if (totalInsulinaDiaria > 0) {
                    effectiveRatio = totalInsulinaDiaria / 10;
                } else {
                    effectiveRatio = 0; // If no insulin, then effective ratio is 0 for this check
                }
            }


            if (parseFloat(racionesComidaActualInput.value) === 0 && effectiveRatio > 0) {
                document.getElementById('avisoRacionesCero').style.display = 'block';
            } else {
                document.getElementById('avisoRacionesCero').style.display = 'none';
            }
        });
    });
  </script>
</body>
</html>