<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calculadora Dosis de Insulina - Hospital Universitario La Merced</title>
  <style>
    /* Reset básico para asegurar box-sizing */
    *, *::before, *::after {
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 1rem auto;
      padding: 0 1rem;
      background-image: url('Imagen de fondo presentación.png'); /* IMAGEN DE FONDO */
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      background-color: #f9f9f9;
      color: #333;
      font-size: 1em;
    }
    h1, h2 {
      color: #008000;
      font-size: 1.8em;
      margin-top: 1.5rem;
      margin-bottom: 0.8rem;
    }
    h1 {
      text-align: center;
      font-size: 2.2em;
    }
    .hospital-info {
      text-align: center;
      margin-bottom: 1.5rem;
    }
    .hospital-info h2 {
        font-size: 1.5em;
        margin-bottom: 0.2em;
        color: #008000;
    }
    .hospital-info p {
        font-size: 0.9em;
        color: #555;
        margin-top: 0;
    }
    .main-title {
        text-align: center;
        font-size: 1.8em;
        color: #008000;
        /* Verde oscuro */
        font-weight: bold;
        margin-top: 1rem;
        margin-bottom: 1.5rem;
    }
    label {
      font-weight: bold;
      display: block;
      margin-top: 1em;
    }
    input[type=number], select, .input-text-styled {
      width: 100%;
      max-width: 200px;
      /* Incrementado para mejor pulsación en móvil */
      padding: 0.5em;
      margin-top: 0.2em;
      margin-bottom: 0.6em;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1em;
    }
    .checkbox-inline {
      display: inline-block;
      margin-right: 1.5em; /* Ajustado a em */
      font-size: 1em;
    }
    .checkbox-inline input {
      margin-right: 0.5em;
      vertical-align: middle;
    }
    #datosAyerContainer, #correccionRatioContainerMedio {
      background: #e6ffe6;
      border: 1px solid #99e699;
      padding: 1em;
      margin-top: 0.8em;
      border-radius: 6px;
    }
    button {
      margin-top: 1.2em;
      padding: 0.7em 1.2em;
      background-color: #008000;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 1.1em;
      cursor: pointer;
      width: auto;
      display: block;
    }
    button:hover {
      background-color: #005500;
    }
    .resultado {
      margin-top: 1.5em;
      font-size: 1.3em;
      font-weight: bold;
      color: #004d00;
    }
    .resultado-aviso {
        font-size: 0.9em;
        color: #cc0000;
        margin-top: 0.5em;
        font-weight: normal;
    }
    .resultado-aviso.alerta-correccion {
        color: orange;
    }
    pre.pasos {
      background: #e6ffe6;
      border: 1px solid #99e699;
      padding: 1em;
      white-space: pre-wrap;
      margin-top: 1em;
      border-radius: 6px;
      font-size: 0.9em;
      line-height: 1.4;
    }
    .pasos-correccion-ratio, .pasos-calculo-ratio-basico {
        background: #e6ffe6;
        border: 1px solid #99e699;
        padding: 1em;
        white-space: pre-wrap;
        margin-top: 1em;
        border-radius: 6px;
        font-size: 0.85em;
        line-height: 1.4;
    }
    .error-message {
      color: red;
      font-size: 0.85em;
      margin-top: -0.4em;
      margin-bottom: 0.4em;
      display: none;
    }
    .logo-container {
        text-align: center;
        margin-bottom: 1.5rem;
    }
    .logo-container img {
        max-width: 400px;
        height: auto;
        display: block;
        margin: 0 auto;
    }
    .disclaimer-text p {
        margin-bottom: 0.5em;
    }
    .aviso-extra {
        font-size: 0.95em;
        color: #555;
        margin-top: 1em;
        line-height: 1.4;
    }
    .mensaje-rojo {
        color: red;
        font-weight: bold;
        margin-top: 0.8em;
    }
    .mensaje-rojo-cursiva {
      color: red;
      font-style: italic;
      margin-top: -0.4em;
      margin-bottom: 0.4em;
      display: none;
    }
    /* Estilo para el mensaje de corrección alta en rojo y negrita */
    #correccionAltaAviso {
        color: red;
        font-weight: bold;
    }
    /* New style for hipoglucemia warning */
    #riesgoHipoglucemiaAviso {
        color: red;
        font-weight: bold;
    }
    .strong-black-text {
      color: black;
      font-weight: bold;
    }
    #emergenciaAviso {
      color: red;
      font-weight: bold;
      margin-top: 0.5em;
      display: none;
    }
    /* New style for exercise adjustment container */
    #ajusteDeporteContainer {
      background: #f0f8ff;
      border: 1px solid #add8e6;
      padding: 1em;
      margin-top: 0.8em;
      border-radius: 6px;
    }
    #ajusteDeporteContainer p {
        margin-bottom: 0.5em;
    }

    /* Estilos de los contenedores de ajuste copiados de 13e.txt */
    .ajuste-ejemplos {
        font-style: italic;
        font-size: 0.9em;
        line-height: 1.4;
        margin-top: 0.5em;
    }
    .input-error {
        border-color: red !important;
    }


    /* Media Queries para pantallas pequeñas (smartphones) */
    @media (max-width: 600px) {
      body {
        font-size: 1.1em;
        padding: 0 0.8rem;
      }
      h1 {
        font-size: 1.8em;
      }
      h2 {
        font-size: 1.4em;
      }
      label, input[type=number], select { /* Aplicar a label y select también */
        font-size: 1.1em;
      }
      input[type=number], select {
        max-width: 100%;
        padding: 0.6em;
      }
      button {
        font-size: 1.1em;
        width: 100%;
        padding: 0.8em 1em;
      }
      .resultado {
        font-size: 1.2em;
      }
      pre.pasos, .pasos-correccion-ratio, .pasos-calculo-ratio-basico {
        font-size: 0.95em;
      }
      .checkbox-inline {
        display: block;
        margin-right: 0;
        margin-bottom: 0.5em;
      }
      .logo-container img {
        max-width: 150px;
      }
    }
  </style>
</head>
<body>

  <div class="logo-container">
    <img src="COLOR_3_TINTAS.jpg" alt="Logo Área de Gestión Sanitaria de Osuna" />
  </div>

  <div class="hospital-info">
    <h1>Hospital Universitario La Merced</h1>
    <h2>Consulta de Diabetes</h2>
    <p>Francisco José Osuna Navarro</p>

    <h1 style="color: green;">CALCULADORA AVANZADA DE DOSIS DE INSULINA RÁPIDA</h1>

  </div>

  <div class="disclaimer-text">
    <p>Esta herramienta tiene como objetivo ayudar para el cálculo de la dosis de insulina rápida a administrar, simplificando operaciones complejas y ayudando a la persona con diabetes
 
    a 
    aplicar lo aprendido 
 
    durante su Educación Terapéutica en Diabetes.</p>
    <p>El uso correcto de esta calculadora parte del conocimiento adquirido en consulta y debe formar 
    parte de una estrategia de autocuidado supervisada.</p>
  </div>

  <hr>

  <p><strong>Edición en pruebas.
    Versión 1b.</strong></p>

  <h2>1. Insulina y glucemia</h2>

  <label for="rapida">¿Cuántas unidades de insulina rápida se administra cada día en total?
    (de media en los últimos 2 días):</label>
  <input id="rapida" type="number" min="3" max="100" step="0.1" />
  <span class="error-message" id="errorRapida"></span>

  <label for="lenta">¿Cuántas unidades de insulina lenta se administra cada día en total?
    (de media en los últimos 2 días):</label>
  <input id="lenta" type="number" min="5" max="100" step="0.1" />
  <span class="error-message" id="errorLenta"></span>

  <label for="glucemiaActual">¿Qué glucemia tiene ANTES de esta comida (mg/dL):</label>
  <input id="glucemiaActual" type="text" class="input-text-styled" />
  <span class="error-message" id="errorGlucemiaActual"></span>
  <div id="emergenciaAviso" class="mensaje-rojo" style="display:none;">
    ¡ATENCIÓN: Valores inferiores a 55 mg/dl o superiores a 450, o los valores “LO” o “HI” pueden ser una EMERGENCIA DIABETOLÓGICA.
    Confirme la glucemia (haga una prueba capilar para comprobar el resultado).
    Solucione esta situación cuanto antes o llame a los servicios de emergencia (112).
  </div>

  <label for="flechaGlucemia">Si usted tiene Monitorización, indique cómo está la flecha:</label>
  <select id="flechaGlucemia">
    <option value="estable">Estable</option>
    <option value="ascenso_lento">Ascenso lento</option>
    <option value="ascenso_rapido">Ascenso rápido</option>
    <option value="descenso_lento">Descenso 
    lento</option>
    <option value="descenso_rapido">Descenso rápido</option>
  </select>

  <label for="glucemiaObjetivo">¿Cuál es la glucemia que quiere tener DESPUÉS de 3 horas?
    (mg/dL) (Por defecto 120). Por la noche, o en personas muy sensibles o con fragilidad, puede indicarse 150 o un valor mayor):</label>
  <input id="glucemiaObjetivo" type="number" min="100" max="180" step="1" value="120" />
  <span class="error-message" id="errorGlucemiaObjetivo"></span>

  <hr>

  <h2>2.
    Ratio</h2>

  <label for="ratioInput">Ratio Insulina/Carbohidratos (unidades de insulina por ración), si la conoce, indíquela:</label>
  <p style="font-style: italic; font-weight: normal; font-size: 0.9em; margin-top: 0.5em; margin-bottom: 0.5em;">Recuerde que los datos de la ratio del desayuno de ayer servirán como base para el desayuno de hoy y así sucesivamente.
    No utilice los datos de ratio de una comida para otra distinta.</p>
  <input id="ratioInput" type="number" min="0" max="6" step="0.01" />
  <span class="error-message" id="errorRatioInput"></span>
  
  <br />
  <label class="checkbox-inline">
    <input type="checkbox" id="noConozcoRatio" onchange="toggleRatioInput()" />
    1. AJUSTE BÁSICO: No conozco la ratio, necesito ayuda para calcularla.
  </label>

  <label class="checkbox-inline">
    <input type="checkbox" id="necesitoCorregirRatioMedio" onchange="toggleCorreccionRatio('Medio')" />
    2. AJUSTE AVANZADO: Conozco mi ratio para esta comida, pero no funcionó ayer.
    Necesito ayuda para corregirla.
  </label>

  <br />

  <div id="datosAyerContainer" style="display:none;">
    <p>Este apartado está pensado para iniciarse en los cálculos de ratio de insulina por ración.
      Este valor deberá ir ajustándose con el paso de los días.
      En su cálculo no se tiene en cuenta, composición de la comida, deporte,... </p>
    <p>El objetivo de la ratio insulina/carbohidratos es lograr que, aproximadamente tres horas después de la administración de insulina rápida, los valores de glucemia se encuentren en niveles similares a los registrados antes de la ingesta.
      Esto indicaría que la insulina administrada y los hidratos de carbono consumidos han ejercido un efecto compensatorio.</p>

    <label for="glucemiaPreviaAyer">Ayer, ¿Cuál era la glucemia ANTES de esa comida:</label>
    <input id="glucemiaPreviaAyer" type="number" min="55" max="450" step="1" value="120"/>
    <span class="error-message" id="errorGlucemiaPreviaAyer"></span>

    <label for="glucemia3hAyerNoConozco">Ayer, ¿Cuál era la glucemia 3 horas DESPUÉS?</label>
    <input id="glucemia3hAyerNoConozco" type="number" min="55" max="450" step="1" value="120"/>
    <span class="error-message" id="errorGlucemia3hAyerNoConozco"></span>

    <label for="insulinaAyer">¿Cuántas UNIDADES de insulina rápida se administró ayer para 
 
    esa comida?</label>
    <input id="insulinaAyer" type="number" 
    min="0" step="0.1" 
    />
    <span class="error-message" id="errorInsulinaAyer"></span>

    <label for="racionesAyer">¿Cuántas RACIONES (de 10 g HC) tomó ayer para esa comida?</label>
    <input id="racionesAyer" type="number" min="0" max="25" step="0.1" />
    <span class="error-message" id="errorRacionesAyer"></span>

    <button type="button" onclick="calcularRatioNoConozco()">Calcular ratio</button>
    <div id="resultadoRatioNoConozco" style="margin-top: 1rem;
      font-weight: bold; color: #004d00;"></div>
    <div class="pasos-calculo-ratio-basico" id="pasosCalculoRatioNoConozco" style="display:none;"></div>
  </div>

  <div id="correccionRatioContainerMedio" style="display:none;
    margin-top:1rem;">
    <p><u><b>Para corregir la ratio de ayer (con ajuste avanzado), introduzca los siguientes datos:</b></u></p>
    <p style="font-style: italic;">ATENCIÓN: Si ayer, antes o después de esta misma comida (desayuno, almuerzo, merienda o cena) realizó ajustes por deporte o composición de los alimentos, estos cálculos pueden ser inexactos.</p>
    <br>

    <label for="glucemia3hAyerMedio">¿Qué glucemia tuvo ayer, 3 horas DESPUÉS de esa comida?</label>
    <input id="glucemia3hAyerMedio" type="number" min="55" max="450" step="1" />
   
  
    <span class="error-message" id="errorGlucemia3hAyerMedio"></span>

    <div style="display:none;">
      <label for="glucemiaObjetivoRatio">¿Cuál era ayer, la glucemia objetivo a las 3 horas de 
    esa comida?</label>
      <input id="glucemiaObjetivoRatio" type="number" min="100" max="180" step="1" value="120" />
      <span class="error-message" id="errorGlucemiaObjetivoRatio"></span>
    </div>

  
 
    <label 
    for="racionesComidaAyerMedio">¿Cuántas RACIONES tomó ayer 
    en esa comida?
    (10 g HC):</label>
    <input id="racionesComidaAyerMedio" type="number" min="0" max="25" step="0.1" />
    <span class="error-message" id="errorRacionesComidaAyerMedio"></span>

    <label for="ratioUtilizadaAyerMedio">¿Cuál fue la RATIO utilizada ayer?
    (Insulina/Ración):</label>
    <input id="ratioUtilizadaAyerMedio" type="number" min="0" max="10" step="0.01" />
    <span class="error-message" id="errorRatioUtilizadaAyerMedio"></span>

    <label>¿Tuvo HIPOGLUCEMIA/S en las 3 horas siguientes a la administración de la insulina de esa comida?</label>
    <select id="hipoglucemiaAyerMedio" onchange="toggleRacionesHipoglucemia('Medio')">
      <option value="no" selected>No</option>
      <option value="si">Sí</option>
   </select>

    <div id="racionesHipoglucemiaContainerMedio" style="display:none; margin-top:0.5rem;">
      <label for="racionesParaHipoglucemiaMedio">Raciones (10 g HC) que tomó para revertir hipoglucemia:</label>
      <input id="racionesParaHipoglucemiaMedio" type="number" min="0.5" max="6" step="0.1" />
  
 
    
    <span class="error-message" 
    id="errorRacionesHipoglucemiaMedio"></span>
    </div>
    
    <button type="button" onclick="calcularCorreccionRatio('Medio')">Calcular ratio corregida</button>

    <div id="resultadoCorreccionRatioMedio" style="margin-top: 1rem;
      font-weight: bold; color: #008000;"></div>
    <br>
    <div class="pasos-correccion-ratio" id="pasosCorreccionRatioMedio" style="display:none;"></div>
  </div>

  <hr>

  <h2>3. Comida y actividad</h2>

  <label for="racionesComidaActual">¿Cuántas Raciones va a comer en esta comida? (10 g HC):</label>
  <input id="racionesComidaActual" type="number" min="0" max="25" step="0.1" />
  <span class="error-message" id="errorRacionesComidaActual"></span>

  <label for="comidaComposicion">¿Cómo es la composición de esta comida?</label>
  <select id="comidaComposicion" onchange="toggleAjusteComposicion()">
    <option value="normal" selected>Normal</option>
    <option value="liviana">Liviana</option>
    <option 
 
    value="pesada">Pesada</option>
  
    </select>

  <div id="ajusteLivianaContainer" style="display:none;">
    <p>Se trata de una comida con menos proteína y/o grasa de lo habitual.
      Para evitar una hipoglucemia, es recomendable RESTAR una dosis de insulina entre 0.5 y 3 unidades de insulina para compensarlo.</p>
    <label for="ajusteLiviana">Ajuste de dosis a REDUCIR (Unidades):</label>
    <input id="ajusteLiviana" type="number" min="0.5" max="3" step="0.5" />
    <span class="error-message" id="errorAjusteLiviana">Introduce un valor válido entre 0.5 y 3.</span>
  </div>

  <div id="ajustePesadaContainer" style="display:none;">
    <p>Se trata de una comida con más proteína y/o grasa de lo habitual.
      Para evitar una hiperglucemia de forma tardía, es recomendable SUMAR una dosis de insulina entre 0.5 y 3 unidades de insulina para compensarlo.</p>
    <label for="ajustePesada">Ajuste de dosis (Unidades):</label>
    <input id="ajustePesada" type="number" min="0.5" max="3" step="0.5" />
    <span class="error-message" id="errorAjustePesada">Introduce un valor válido entre 0.5 y 3.</span>
  </div>


  <label for="deporteAntes">¿Ha realizado 
    deporte/trabajo 
    físico antes de esta comida?</label>
  <select id="deporteAntes" onchange="toggleAjusteDeporteAntes()">
    <option value="no" selected>No</option>
    <option value="si">Sí</option>
  </select>

  <div id="ajusteDeporteAntesContainer" style="display:none;">
    <p>
  
      
    El ejercicio aumenta la sensibilidad de 
    tu cuerpo a la insulina.
    </p>
    <p>
      Ajuste recomendado: REDUCE la dosis entre 1 y 4 unidades.
      Elige el valor en función de la intensidad y la duración del ejercicio.
      Por ejemplo:
    </p>
    <div class="ajuste-ejemplos">
      <p>
        Ejercicio ligero o corto (paseo, estiramientos):
        <br>
        Reduce la dosis en 1 unidad.
      </p>
      <p>
        Ejercicio moderado (correr, nadar, bicicleta): Reduce
        <br>
        la dosis en 2 unidades.
      </p>
      <p>
        Ejercicio intenso o prolongado (deportes de equipo,
        <br>
        gimnasio): Reduce la dosis en 3 a 4 unidades.
      </p>
    </div>
    <label for="ajusteDeporteAntes">Ajuste de dosis a REDUCIR (Unidades):</label>
    <input id="ajusteDeporteAntes" type="number" min="0.5" max="5" step="0.5" />
    <span class="error-message" id="errorAjusteDeporteAntes">Introduce un valor válido entre 0.5 y 5.</span>
  </div>


  <label for="deporteDespues">¿Va a hacer deporte/trabajo físico después de esta comida?</label>
  <select id="deporteDespues" onchange="toggleAjusteDeporteDespues()">
    <option value="no" selected>No</option>
    <option value="si">Sí</option>
  </select>

  <div id="ajusteDeporteDespuesContainer" style="display:none;">
    <p>
      La insulina que te inyectes ahora actuará durante las próximas 3 horas, si en este tiempo realizas un consumo 
 
    extra 
     de glucosa debido al ejercicio o trabajo intenso, puedes tener una hipoglucemia.
    </p>
    <p>
      Ajuste recomendado: REDUCE la dosis entre 1 y 4 unidades.
      Elige el valor en función de la intensidad y la duración del ejercicio.
      Por ejemplo:
    </p>
    <div class="ajuste-ejemplos">
      <p>
        Ejercicio ligero o corto (paseo, estiramientos):
        <br>
        Reduce la dosis en 1 unidad.
      </p>
      <p>
        Ejercicio moderado (correr, nadar, bicicleta): Reduce
        <br>
        la dosis en 2 unidades.
      </p>
      <p>
        Ejercicio intenso o prolongado (deportes de equipo,
        <br>
        gimnasio): Reduce la dosis en 3 a 4 unidades.
      </p>
    </div>
    <label for="ajusteDeporteDespues">Ajuste de dosis a REDUCIR (Unidades):</label>
    <input id="ajusteDeporteDespues" type="number" min="0.5" max="5" step="0.5" />
    <span class="error-message" id="errorAjusteDeporteDespues">Introduce un valor válido entre 0.5 y 5.</span>
  </div>


  <label for="hipoglucemiaActual">¿Ayer tuvo usted hipoglucemia después de esta comida?:</label>
  <select id="hipoglucemiaActual">
    <option value="no">No</option>
    <option value="si">Sí</option>
  </select>

  <hr>

  <h2>4.
    Cálculos</h2>
  <button onclick="calcularInsulina()">Calcular dosis de insulina</button>

  <p class="mensaje-rojo" id="avisoSinRaciones" style="display:none;">No ha indicado el ratio y/o raciones de esta comida. El resultado obtenido solo es útil si va a corregir su nivel actual de glucosa, pero sin comer. </p>
  <div class="resultado" id="resultado"></div>
  <p class="mensaje-rojo" id="validationErrorAviso" style="display:none;">Revise los valores introducidos, puede que no sean válidos.</p>
  <p class="resultado-aviso" id="dosisAltaAviso" style="display:none;">⚠️ Esta es una dosis alta para usted.
    Por favor, revise los datos introducidos.</p>
  <p class="resultado-aviso" id="correccionAltaAviso" style="display:none;">⚠️ Dosis de corrección alta ¿Está seguro?</p>
  <p id="riesgoHipoglucemiaAviso" style="display:none;"></p>
  <p class="strong-black-text">Los resultados ofrecidos son únicamente orientativos y no sustituyen la consulta ni las indicaciones de su profesional sanitario.</p>
  <p class="aviso-extra">Puede que esta dosis de insulina necesite algún ajuste extra como es el caso de situaciones por enfermedad (fiebre, diarrea,...), algunos tratamientos (corticoides,...), menstruación,... que pueden hacer variar estos cálculos.
    Consulta con tu profesional.</p>
  <pre class="pasos" id="pasos"></pre>
  
  <button onclick="window.location.href='https://fosunan.github.io/Calculadoras-de-insulina/'">Volver al Menú Principal</button>

  <script>
    // Función genérica para validar input y mostrar mensaje de error
    function validateInput(inputId, errorId, condition) {
      const input = document.getElementById(inputId);
      const errorSpan = document.getElementById(errorId);
      const min = input.getAttribute('min');
      const max = input.getAttribute('max');
      if (!condition(input.value)) {
        input.classList.add('input-error');
        if (min !== null && max !== null) {
            errorSpan.textContent = `Introduce un valor válido entre ${min} y ${max}.`;
        } else if (min !== null) {
            errorSpan.textContent = `Introduce un valor válido mayor o igual a ${min}.`;
        } else if (max !== null) {
            errorSpan.textContent = `Introduce un valor válido menor o igual a ${max}.`;
        } else {
            errorSpan.textContent = `Introduce un valor válido.`;
        }
        errorSpan.style.display = 'block';
        return false;
      } else {
        input.classList.remove('input-error');
        errorSpan.style.display = 'none';
        return true;
      }
    }

    // Funciones de validación específicas
    const isPositiveNumber = (value) => parseFloat(value) > 0;
    const isNonNegativeNumber = (value) => parseFloat(value) >= 0;
    
    // Función de validación de rango genérica
    function isWithinRange(value, min, max) {
      const numValue = parseFloat(value);
      return !isNaN(numValue) && numValue >= min && numValue <= max;
    }

    // Redondeo a la media unidad más cercana
    function roundToHalf(num) {
        return Math.round(num * 2) / 2;
    }

    // New function for ratio display (1 decimal place without rounding)
    function formatRatio(num) {
        return num.toFixed(1);
    }

    // Helper to clear inputs and hide errors in a container
    function clearInputsAndResults(containerId) {
        const container = document.getElementById(containerId);
        if (!container) return;

        // Clear input values
        container.querySelectorAll('input[type="number"]').forEach(input => {
            input.value = '';
        });
        // Reset select values to first option if applicable, or default
        container.querySelectorAll('select').forEach(select => {
            select.selectedIndex = 0;
        });
        // Hide error messages
        container.querySelectorAll('.error-message').forEach(errorSpan => {
            errorSpan.style.display = 'none';
        });
        // Hide and clear results/steps
        container.querySelectorAll('[id^="resultado"], [id^="pasos"]').forEach(el => {
            el.textContent = '';
            el.style.display = 'none';
        });
        // Special clear for hipoglucemia containers
        if (containerId === 'correccionRatioContainerMedio') {
            document.getElementById(`racionesHipoglucemiaContainerMedio`).style.display = 'none';
        }
    }

    // Mostrar/ocultar inputs según checkbox "No conozco la ratio"
    function toggleRatioInput() {
      const checkbox = document.getElementById('noConozcoRatio');
      const datosAyerContainer = document.getElementById('datosAyerContainer');
      const ratioInput = document.getElementById('ratioInput');
      const necesitaCorregirRatioMedio = document.getElementById('necesitoCorregirRatioMedio');
      const correccionRatioContainerMedio = document.getElementById('correccionRatioContainerMedio');
      const pasosCalculoRatioNoConozco = document.getElementById('pasosCalculoRatioNoConozco');

      if (checkbox.checked) {
        datosAyerContainer.style.display = 'block';
        ratioInput.value = '';
        // Clear and hide other sections
        necesitoCorregirRatioMedio.checked = false;
        clearInputsAndResults('correccionRatioContainerMedio');
        correccionRatioContainerMedio.style.display = 'none';

        document.getElementById('resultadoRatioNoConozco').textContent = '';
        pasosCalculoRatioNoConozco.style.display = 'none';
        pasosCalculoRatioNoConozco.textContent = '';
      } else {
        clearInputsAndResults('datosAyerContainer');
        datosAyerContainer.style.display = 'none';

        ratioInput.disabled = false;
      }
      document.getElementById('errorRatioInput').style.display = 'none';
    }

    // Mostrar/ocultar inputs según checkbox "Necesito corregir mi ratio conocida"
    function toggleCorreccionRatio(tipoAjuste) {
      const checkboxMedio = document.getElementById('necesitoCorregirRatioMedio');
      const contenedorMedio = document.getElementById('correccionRatioContainerMedio');
      const noConozcoRatio = document.getElementById('noConozcoRatio');
      const datosAyerContainer = document.getElementById('datosAyerContainer');
      const ratioInput = document.getElementById('ratioInput');
      // Clear and hide "1. AJUSTE BÁSICO" section
      noConozcoRatio.checked = false;
      clearInputsAndResults('datosAyerContainer');
      datosAyerContainer.style.display = 'none';
      // This function is called onchange, so checkboxMedio.checked reflects the *new* state
      if (checkboxMedio.checked) { // User just checked "2. AJUSTE AVANZADO"
        contenedorMedio.style.display = 'block';
        ratioInput.disabled = false; // Ensure ratioInput is enabled
      } else { // User just unchecked "2. AJUSTE AVANZADO"
        contenedorMedio.style.display = 'none';
        clearInputsAndResults('correccionRatioContainerMedio');
        ratioInput.value = ''; // Clear the main ratio input
      }
      document.getElementById('errorRatioInput').style.display = 'none';
    }

    // Mostrar/ocultar input para raciones para hipoglucemia
    function toggleRacionesHipoglucemia(tipoAjuste) {
      const select = document.getElementById(`hipoglucemiaAyer${tipoAjuste}`);
      const contenedor = document.getElementById(`racionesHipoglucemiaContainer${tipoAjuste}`);
      const inputRaciones = document.getElementById(`racionesParaHipoglucemia${tipoAjuste}`);
      const errorRaciones = document.getElementById(`errorRacionesHipoglucemia${tipoAjuste}`);
      if (select.value === 'si') {
        contenedor.style.display = 'block';
      } else {
        contenedor.style.display = 'none';
        inputRaciones.value = '';
        errorRaciones.style.display = 'none';
      }
    }

    // Funciones para mostrar/ocultar contenedores de ajuste (copiadas de 13e)
    function toggleAjusteComposicion() {
      const select = document.getElementById('comidaComposicion');
      document.getElementById('ajusteLivianaContainer').style.display = 'none';
      document.getElementById('ajustePesadaContainer').style.display = 'none';
      if (select.value === 'liviana') {
        document.getElementById('ajusteLivianaContainer').style.display = 'block';
      } else if (select.value === 'pesada') {
        document.getElementById('ajustePesadaContainer').style.display = 'block';
      }
    }

    function toggleAjusteDeporteAntes() {
      const select = document.getElementById('deporteAntes');
      document.getElementById('ajusteDeporteAntesContainer').style.display = (select.value === 'si') ? 'block' : 'none';
    }

    function toggleAjusteDeporteDespues() {
      const select = document.getElementById('deporteDespues');
      document.getElementById('ajusteDeporteDespuesContainer').style.display = (select.value === 'si') ? 'block' : 'none';
    }

    // Calculate ratio when "No conozco ratio" is selected
    function calcularRatioNoConozco() {
      let isValid = true;
      const rapida = parseFloat(document.getElementById('rapida').value);
      isValid = validateInput('rapida', 'errorRapida', value => isWithinRange(value, 3, 100)) && isValid;
      isValid = validateInput('lenta', 'errorLenta', value => isWithinRange(value, 5, 100)) && isValid;
      isValid = validateInput('glucemiaPreviaAyer', 'errorGlucemiaPreviaAyer', value => isWithinRange(value, 55, 450)) && isValid;
      isValid = validateInput('glucemia3hAyerNoConozco', 'errorGlucemia3hAyerNoConozco', value => isWithinRange(value, 55, 450)) && isValid;

      // Special validation for 'insulinaAyer' based on 'rapida'
      const insulinaAyerInput = document.getElementById('insulinaAyer');
      const insulinaAyerValue = parseFloat(insulinaAyerInput.value);
      const errorInsulinaAyerSpan = document.getElementById('errorInsulinaAyer');
      if (insulinaAyerValue < 0 || insulinaAyerValue > rapida || isNaN(insulinaAyerValue)) {
        insulinaAyerInput.classList.add('input-error');
        errorInsulinaAyerSpan.textContent = `Introduce un valor válido entre 0 y ${rapida}.`;
        errorInsulinaAyerSpan.style.display = 'block';
        isValid = false;
      } else {
        insulinaAyerInput.classList.remove('input-error');
        errorInsulinaAyerSpan.style.display = 'none';
      }

      isValid = validateInput('racionesAyer', 'errorRacionesAyer', value => isWithinRange(value, 0, 25)) && isValid;
      
      if (!isValid) {
        document.getElementById('resultadoRatioNoConozco').textContent = 'Por favor, corrija los errores para calcular la ratio.';
        document.getElementById('pasosCalculoRatioNoConozco').style.display = 'none';
        return;
      }

      const glucemiaPreviaAyer = parseFloat(document.getElementById('glucemiaPreviaAyer').value);
      const glucemia3hAyerNoConozco = parseFloat(document.getElementById('glucemia3hAyerNoConozco').value);
      const insulinaAyer = parseFloat(document.getElementById('insulinaAyer').value);
      const racionesAyer = parseFloat(document.getElementById('racionesAyer').value);
      const totalInsulina = parseFloat(document.getElementById('rapida').value) + parseFloat(document.getElementById('lenta').value);
      const constanteCorreccion = 1800; // Hard-coded value
      const factorCorreccion = totalInsulina > 0 ?
      constanteCorreccion / totalInsulina : 0; // Avoid division by zero
      let pasosTexto = `Pasos para calcular la ratio:\n\n`;
      const ratioAdministradaAyer = racionesAyer > 0 ? insulinaAyer / racionesAyer : 0;
      pasosTexto += `1.
        Cálculo de la Ratio que administró usted ayer: Unidades de insulina rápida (${insulinaAyer.toFixed(1)} Unidades) / Raciones tomadas (${racionesAyer.toFixed(1)} Raciones) = ${formatRatio(ratioAdministradaAyer)} Unidades/Ración.\n`;
      let correccionGlucemiaAyer = glucemia3hAyerNoConozco - glucemiaPreviaAyer;
      pasosTexto += `2. Corrección glucemia de ayer: Glucemia posterior a las 3 horas (${glucemia3hAyerNoConozco.toFixed(0)} mg/dL) - Glucemia previa (${glucemiaPreviaAyer.toFixed(0)} mg/dL) = ${correccionGlucemiaAyer.toFixed(0)} mg/dL.\n`;
      let correccionUnidadesAyer = 0;
      if (factorCorreccion > 0) {
        correccionUnidadesAyer = correccionGlucemiaAyer / factorCorreccion;
        pasosTexto += `3.
          Corrección unidades de ayer: Corrección glucemia de ayer (${correccionGlucemiaAyer.toFixed(0)} mg/dL) / Factor de Corrección de Insulina (${factorCorreccion.toFixed(2)} mg/dL/unidad) = ${correccionUnidadesAyer.toFixed(2)} Unidades.\n`;
      } else {
        pasosTexto += `3. No se puede calcular la Corrección unidades de ayer porque el Factor de Corrección de Insulina es cero.\n`;
      }
      let nuevaRatio = 0;
      if (racionesAyer > 0) {
        if (correccionUnidadesAyer < 0) { // If correction is negative (glucemia was lower than previous)
          nuevaRatio = (insulinaAyer - Math.abs(correccionUnidadesAyer)) / racionesAyer;
          pasosTexto += `4. La Corrección unidades de ayer es negativa.
          Se resta el valor absoluto de la corrección: (Unidades de insulina administradas ayer (${insulinaAyer.toFixed(1)} Unidades) - |Corrección unidades de ayer| (${Math.abs(correccionUnidadesAyer).toFixed(2)} Unidades)) / Raciones tomadas (${racionesAyer.toFixed(1)} Raciones) = ${formatRatio(nuevaRatio)} Unidades/Ración.\n`;
        } else {
          nuevaRatio = (insulinaAyer + correccionUnidadesAyer) / racionesAyer;
          pasosTexto += `4.
            Se suma: (Unidades de insulina administradas ayer (${insulinaAyer.toFixed(1)} Unidades) + Corrección unidades de ayer (${correccionUnidadesAyer.toFixed(2)} Unidades)) / Raciones tomadas (${racionesAyer.toFixed(1)} Raciones) = ${formatRatio(nuevaRatio)} Unidades/Ración.\n`;
        }
      } else {
        pasosTexto += `4. No se puede calcular la nueva ratio porque las raciones tomadas son cero.\n`;
      }

      document.getElementById('resultadoRatioNoConozco').innerHTML = '<span style="color: #008000; font-weight: bold;">La ratio necesaria habría sido de ' + formatRatio(nuevaRatio) + ' Unidades/Ración.</span>';
      document.getElementById('pasosCalculoRatioNoConozco').innerHTML = pasosTexto.replace(/\n/g, '<br>');
      document.getElementById('pasosCalculoRatioNoConozco').style.display = 'block';

      // Actualizar el valor de ratioInput con la nuevaRatio redondeada a 1 decimal
      document.getElementById('ratioInput').value = nuevaRatio.toFixed(1);
    }


    // Calculate corrected ratio for Medio (now Avanzado) adjustment
    function calcularCorreccionRatio(tipoAjuste) {
      // tipoAjuste will always be 'Medio' now
      let isValid = true;
      const resultadoElement = document.getElementById(`resultadoCorreccionRatioMedio`);
      const pasosElement = document.getElementById(`pasosCorreccionRatioMedio`);
      let pasosTexto = `Pasos para corregir la ratio de ayer:\n\n`;

      isValid = validateInput('glucemia3hAyerMedio', 'errorGlucemia3hAyerMedio', value => isWithinRange(value, 55, 450)) && isValid;
      isValid = validateInput('racionesComidaAyerMedio', 'errorRacionesComidaAyerMedio', value => isWithinRange(value, 0, 25)) && isValid;
      isValid = validateInput('ratioUtilizadaAyerMedio', 'errorRatioUtilizadaAyerMedio', value => isWithinRange(value, 0, 10)) && isValid;
      
      const hipoglucemiaAyer = document.getElementById(`hipoglucemiaAyerMedio`).value;
      let racionesHipoglucemia = 0;
      if (hipoglucemiaAyer === 'si') {
        const racionesHipoglucemiaInput = document.getElementById(`racionesParaHipoglucemiaMedio`);
        const racionesHipoglucemiaValue = parseFloat(racionesHipoglucemiaInput.value);
        isValid = validateInput('racionesParaHipoglucemiaMedio', 'errorRacionesHipoglucemiaMedio', value => isWithinRange(value, 0.5, 6)) && isValid;
        if(isValid){
          racionesHipoglucemia = racionesHipoglucemiaValue;
        }
      }

      if (!isValid) {
        resultadoElement.textContent = 'Por favor, corrija los errores para calcular la ratio corregida.';
        pasosElement.style.display = 'none';
        return;
      }

      const glucemia3hAyer = parseFloat(document.getElementById('glucemia3hAyerMedio').value);
      const racionesComidaAyer = parseFloat(document.getElementById('racionesComidaAyerMedio').value);
      const ratioUtilizadaAyer = parseFloat(document.getElementById('ratioUtilizadaAyerMedio').value);
      const glucemiaObjetivo = parseFloat(document.getElementById('glucemiaObjetivoRatio').value);
      
      const totalInsulina = parseFloat(document.getElementById('rapida').value) + parseFloat(document.getElementById('lenta').value);
      const constanteCorreccion = 1800; // Hard-coded value
      const factorCorreccion = totalInsulina > 0 ? constanteCorreccion / totalInsulina : 0;
      
      let correccionGlucemia = glucemia3hAyer - glucemiaObjetivo;
      pasosTexto += `1. Diferencia en glucemia: Glucemia a las 3 horas (${glucemia3hAyer.toFixed(0)} mg/dL) - Glucemia objetivo (${glucemiaObjetivo.toFixed(0)} mg/dL) = ${correccionGlucemia.toFixed(0)} mg/dL.\n`;

      let correccionUnidades = 0;
      if (factorCorreccion > 0) {
        correccionUnidades = correccionGlucemia / factorCorreccion;
        pasosTexto += `2. Unidades de corrección: Diferencia en glucemia (${correccionGlucemia.toFixed(0)} mg/dL) / Factor de Corrección de Insulina (${factorCorreccion.toFixed(2)} mg/dL/unidad) = ${correccionUnidades.toFixed(2)} Unidades.\n`;
      } else {
        pasosTexto += `2. No se puede calcular la corrección de unidades, ya que el factor de corrección de insulina es cero.\n`;
      }
      
      let correccionHipoglucemia = 0;
      if (hipoglucemiaAyer === 'si' && racionesHipoglucemia > 0) {
        correccionHipoglucemia = racionesHipoglucemia * ratioUtilizadaAyer;
        pasosTexto += `3. Unidades de corrección por hipoglucemia: Raciones para hipoglucemia (${racionesHipoglucemia.toFixed(1)} Raciones) * Ratio utilizada ayer (${formatRatio(ratioUtilizadaAyer)} U/R) = ${correccionHipoglucemia.toFixed(2)} Unidades.\n`;
      }

      let nuevaRatio = 0;
      if (racionesComidaAyer > 0) {
        nuevaRatio = (insulinaTotalAyer + correccionUnidades + correccionHipoglucemia) / racionesComidaAyer;
        
        let insulinaTotalAyer = racionesComidaAyer * ratioUtilizadaAyer;
        pasosTexto += `3. Cálculo de insulina total inyectada para esa comida ayer: Raciones tomadas (${racionesComidaAyer.toFixed(1)} Raciones) x Ratio utilizada ayer (${formatRatio(ratioUtilizadaAyer)} U/R) = ${insulinaTotalAyer.toFixed(2)} Unidades.\n`;

        let insulinaAjustada = insulinaTotalAyer - correccionUnidades - correccionHipoglucemia;
        pasosTexto += `4. Unidades de insulina a administrar ajustadas: Insulina total inyectada (${insulinaTotalAyer.toFixed(2)} Unidades) - Unidades de corrección (${correccionUnidades.toFixed(2)} Unidades) - Unidades de corrección por hipoglucemia (${correccionHipoglucemia.toFixed(2)} Unidades) = ${insulinaAjustada.toFixed(2)} Unidades.\n`;
        nuevaRatio = insulinaAjustada / racionesComidaAyer;
        
        pasosTexto += `5. Nueva ratio ajustada: Unidades de insulina a administrar ajustadas (${insulinaAjustada.toFixed(2)} Unidades) / Raciones tomadas (${racionesComidaAyer.toFixed(1)} Raciones) = ${formatRatio(nuevaRatio)} Unidades/Ración.\n`;
      } else {
        pasosTexto += `5. No se puede calcular la nueva ratio porque las raciones tomadas ayer son cero.\n`;
      }
      
      resultadoElement.innerHTML = '<span style="color: #008000; font-weight: bold;">La ratio corregida habría sido de ' + formatRatio(nuevaRatio) + ' Unidades/Ración.</span>';
      pasosElement.innerHTML = pasosTexto.replace(/\n/g, '<br>');
      pasosElement.style.display = 'block';

      // Actualizar el valor de ratioInput con la nuevaRatio redondeada a 1 decimal
      document.getElementById('ratioInput').value = nuevaRatio.toFixed(1);
    }
    
    // Función principal de cálculo de insulina
    function calcularInsulina() {
      // Ocultar mensajes de error anteriores
      document.getElementById('resultado').style.display = 'none';
      document.getElementById('pasos').style.display = 'none';
      document.getElementById('dosisAltaAviso').style.display = 'none';
      document.getElementById('correccionAltaAviso').style.display = 'none';
      document.getElementById('riesgoHipoglucemiaAviso').style.display = 'none';
      document.getElementById('emergenciaAviso').style.display = 'none';
      document.getElementById('validationErrorAviso').style.display = 'none';
      document.getElementById('avisoSinRaciones').style.display = 'none';

      // Validar todos los campos antes de proceder
      let isFormValid = true;

      isFormValid = validateInput('rapida', 'errorRapida', value => isWithinRange(value, 3, 100)) && isFormValid;
      isFormValid = validateInput('lenta', 'errorLenta', value => isWithinRange(value, 5, 100)) && isFormValid;
      
      // Special validation for glucemiaActual which can be numbers or 'LO'/'HI'
      const glucemiaActualInput = document.getElementById('glucemiaActual');
      const glucemiaActualValue = glucemiaActualInput.value.toUpperCase();
      const errorGlucemiaActualSpan = document.getElementById('errorGlucemiaActual');
      let glucemiaValida = false;
      const numGlucemia = parseFloat(glucemiaActualValue);

      if (glucemiaActualValue === 'LO' || glucemiaActualValue === 'HI') {
        glucemiaValida = true;
      } else if (!isNaN(numGlucemia) && isWithinRange(numGlucemia, 55, 450)) {
        glucemiaValida = true;
      }

      if (!glucemiaValida) {
        glucemiaActualInput.classList.add('input-error');
        errorGlucemiaActualSpan.textContent = `Introduzca el valor de glucemia actual`;
        errorGlucemiaActualSpan.style.display = 'block';
        isFormValid = false;
      } else {
        glucemiaActualInput.classList.remove('input-error');
        errorGlucemiaActualSpan.style.display = 'none';
      }

      isFormValid = validateInput('glucemiaObjetivo', 'errorGlucemiaObjetivo', value => isWithinRange(value, 100, 180)) && isFormValid;
      isFormValid = validateInput('racionesComidaActual', 'errorRacionesComidaActual', value => isWithinRange(value, 0, 25)) && isFormValid;

      const noConozcoRatioChecked = document.getElementById('noConozcoRatio').checked;
      const necesitoCorregirRatioChecked = document.getElementById('necesitoCorregirRatioMedio').checked;
      
      let ratioInputVal = document.getElementById('ratioInput').value;
      if (!noConozcoRatioChecked && !necesitoCorregirRatioChecked) {
        isFormValid = validateInput('ratioInput', 'errorRatioInput', value => isWithinRange(value, 0, 6)) && isFormValid;
      }

      const comidaComposicion = document.getElementById('comidaComposicion').value;
      if (comidaComposicion === 'liviana') {
        isFormValid = validateInput('ajusteLiviana', 'errorAjusteLiviana', value => isWithinRange(value, 0.5, 3)) && isFormValid;
      } else if (comidaComposicion === 'pesada') {
        isFormValid = validateInput('ajustePesada', 'errorAjustePesada', value => isWithinRange(value, 0.5, 3)) && isFormValid;
      }

      const deporteAntes = document.getElementById('deporteAntes').value;
      if (deporteAntes === 'si') {
        isFormValid = validateInput('ajusteDeporteAntes', 'errorAjusteDeporteAntes', value => isWithinRange(value, 0.5, 5)) && isFormValid;
      }

      const deporteDespues = document.getElementById('deporteDespues').value;
      if (deporteDespues === 'si') {
        isFormValid = validateInput('ajusteDeporteDespues', 'errorAjusteDeporteDespues', value => isWithinRange(value, 0.5, 5)) && isFormValid;
      }

      if (!isFormValid) {
        document.getElementById('validationErrorAviso').style.display = 'block';
        return;
      }

      // Hide validation error message if all inputs are valid
      document.getElementById('validationErrorAviso').style.display = 'none';

      // Continuar con los cálculos solo si la validación es exitosa
      const rapida = parseFloat(document.getElementById('rapida').value);
      const lenta = parseFloat(document.getElementById('lenta').value);
      const totalInsulina = rapida + lenta;
      const glucemiaActual = glucemiaActualValue;
      const glucemiaObjetivo = parseFloat(document.getElementById('glucemiaObjetivo').value);
      const racionesComidaActual = parseFloat(document.getElementById('racionesComidaActual').value);
      let ratio = parseFloat(document.getElementById('ratioInput').value);

      // Si se usan los ajustes de ratio, tomar la ratio de ahí
      if (noConozcoRatioChecked) {
        ratio = parseFloat(document.getElementById('ratioInput').value);
      } else if (necesitoCorregirRatioChecked) {
        ratio = parseFloat(document.getElementById('ratioInput').value);
      }

      // Check for the new warning condition
      const isRatioMissing = isNaN(ratio) || ratio === 0;
      const isRacionesMissing = isNaN(racionesComidaActual) || racionesComidaActual === 0;

      if ((isRatioMissing && !noConozcoRatioChecked && !necesitoCorregirRatioChecked) || isRacionesMissing) {
        document.getElementById('avisoSinRaciones').style.display = 'block';
      }
      
      const constanteCorreccion = 1800;
      const factorCorreccion = totalInsulina > 0 ? constanteCorreccion / totalInsulina : 0;
      let dosisInsulina = 0;
      let dosisComida = 0;
      let dosisCorreccion = 0;
      let dosisAjusteComposicion = 0;
      let dosisAjusteDeporteAntes = 0;
      let dosisAjusteDeporteDespues = 0;
      const hipoglucemiaActual = document.getElementById('hipoglucemiaActual').value;

      // Cálculo de la dosis por comida si la ratio y las raciones son mayores que 0
      if (ratio > 0 && racionesComidaActual > 0) {
        dosisComida = racionesComidaActual * ratio;
      }

      let pasosTexto = `Cálculos:\n\n`;

      // Cálculo de la dosis de corrección
      if (!isNaN(parseFloat(glucemiaActual)) && factorCorreccion > 0) {
        dosisCorreccion = (parseFloat(glucemiaActual) - glucemiaObjetivo) / factorCorreccion;
        pasosTexto += `Cálculo de la corrección:\n`;
        pasosTexto += `Glucemia actual (${glucemiaActual} mg/dL) - Glucemia objetivo (${glucemiaObjetivo} mg/dL) = ${(parseFloat(glucemiaActual) - glucemiaObjetivo).toFixed(0)} mg/dL\n`;
        pasosTexto += `${(parseFloat(glucemiaActual) - glucemiaObjetivo).toFixed(0)} mg/dL / Factor de Corrección de Insulina (${factorCorreccion.toFixed(2)} mg/dL/unidad) = ${dosisCorreccion.toFixed(2)} Unidades.\n\n`;

        // Advertencia si la dosis de corrección es alta
        if (Math.abs(dosisCorreccion) > 4) {
          document.getElementById('correccionAltaAviso').style.display = 'block';
        }
      } else if (glucemiaActual === 'LO') {
        document.getElementById('riesgoHipoglucemiaAviso').style.display = 'block';
        document.getElementById('riesgoHipoglucemiaAviso').textContent = "⚠️ Glucemia actual en 'LO' o <55 mg/dl, riesgo de hipoglucemia. NO ADMINISTRAR INSULINA RÁPIDA. Revise la glucemia de nuevo. En caso de hipoglucemia, administre 1-2 raciones de HC de acción rápida (10-20 g) y luego 1-2 raciones de HC de acción lenta (10-20 g).";
        return; // Detener la ejecución si hay un riesgo de hipoglucemia grave
      } else if (glucemiaActual === 'HI') {
        document.getElementById('emergenciaAviso').style.display = 'block';
        pasosTexto += `Cálculo de la corrección:\n`;
        pasosTexto += `Glucemia actual 'HI' >450. Se calcula la dosis de corrección como si la glucemia actual fuera 450.\n`;
        dosisCorreccion = (450 - glucemiaObjetivo) / factorCorreccion;
        pasosTexto += `(450 mg/dL - ${glucemiaObjetivo} mg/dL) / Factor de Corrección de Insulina (${factorCorreccion.toFixed(2)} mg/dL/unidad) = ${dosisCorreccion.toFixed(2)} Unidades.\n\n`;
      }


      // Cálculo de la dosis por comida si existe ratio y raciones
      if (dosisComida > 0) {
        pasosTexto += `Cálculo por raciones de comida:\n`;
        pasosTexto += `Raciones a comer (${racionesComidaActual.toFixed(1)} Raciones) x Ratio (${ratio.toFixed(2)} Unidades/Ración) = ${dosisComida.toFixed(2)} Unidades.\n\n`;
      }

      // Ajustes por composición
      if (comidaComposicion === 'liviana') {
        dosisAjusteComposicion = -parseFloat(document.getElementById('ajusteLiviana').value);
        pasosTexto += `Ajuste por comida liviana: Reducir ${Math.abs(dosisAjusteComposicion).toFixed(1)} Unidades.\n`;
      } else if (comidaComposicion === 'pesada') {
        dosisAjusteComposicion = parseFloat(document.getElementById('ajustePesada').value);
        pasosTexto += `Ajuste por comida pesada: Sumar ${dosisAjusteComposicion.toFixed(1)} Unidades.\n`;
      }

      // Ajustes por deporte
      if (deporteAntes === 'si') {
        dosisAjusteDeporteAntes = -parseFloat(document.getElementById('ajusteDeporteAntes').value);
        pasosTexto += `Ajuste por deporte antes de la comida: Reducir ${Math.abs(dosisAjusteDeporteAntes).toFixed(1)} Unidades.\n`;
      }
      if (deporteDespues === 'si') {
        dosisAjusteDeporteDespues = -parseFloat(document.getElementById('ajusteDeporteDespues').value);
        pasosTexto += `Ajuste por deporte después de la comida: Reducir ${Math.abs(dosisAjusteDeporteDespues).toFixed(1)} Unidades.\n`;
      }

      dosisInsulina = dosisComida + dosisCorreccion + dosisAjusteComposicion + dosisAjusteDeporteAntes + dosisAjusteDeporteDespues;
      dosisInsulina = roundToHalf(dosisInsulina);

      pasosTexto += `\nCálculo total de la dosis:\n`;
      let dosisComidaTexto = dosisComida > 0 ? `${dosisComida.toFixed(2)} (por raciones) ` : '';
      let dosisCorreccionTexto = dosisCorreccion !== 0 ? `+ ${dosisCorreccion.toFixed(2)} (por corrección) ` : '';
      let dosisAjusteTexto = dosisAjusteComposicion !== 0 ? `+ ${dosisAjusteComposicion.toFixed(2)} (por composición) ` : '';
      let dosisAjusteDeporteAntesTexto = dosisAjusteDeporteAntes !== 0 ? `+ ${dosisAjusteDeporteAntes.toFixed(2)} (por deporte previo) ` : '';
      let dosisAjusteDeporteDespuesTexto = dosisAjusteDeporteDespues !== 0 ? `+ ${dosisAjusteDeporteDespues.toFixed(2)} (por deporte posterior) ` : '';

      pasosTexto += `${dosisComidaTexto}${dosisCorreccionTexto}${dosisAjusteTexto}${dosisAjusteDeporteAntesTexto}${dosisAjusteDeporteDespuesTexto}= ${dosisInsulina.toFixed(1)} Unidades.\n`;

      if (dosisInsulina < 0) {
        dosisInsulina = 0;
      }
      
      const dosisDiariaTotal = rapida + lenta;
      if (dosisInsulina > (dosisDiariaTotal / 3)) {
          document.getElementById('dosisAltaAviso').style.display = 'block';
      }

      if (hipoglucemiaActual === 'si' && dosisInsulina > 0) {
        document.getElementById('riesgoHipoglucemiaAviso').style.display = 'block';
        document.getElementById('riesgoHipoglucemiaAviso').textContent = "⚠️ Riesgo de hipoglucemia. La dosis calculada puede necesitar ser menor si tuvo hipoglucemia ayer.";
      }

      document.getElementById('resultado').textContent = `Dosis de insulina recomendada: ${dosisInsulina.toFixed(1)} Unidades.`;
      document.getElementById('resultado').style.display = 'block';
      document.getElementById('pasos').textContent = pasosTexto;
      document.getElementById('pasos').style.display = 'block';
    }

    // Inicializar el estado de los contenedores de ajuste
    document.addEventListener('DOMContentLoaded', (event) => {
      document.getElementById('ajusteLivianaContainer').style.display = 'none';
      document.getElementById('ajustePesadaContainer').style.display = 'none';
      document.getElementById('ajusteDeporteAntesContainer').style.display = 'none';
      document.getElementById('ajusteDeporteDespuesContainer').style.display = 'none';
    });
  </script>
</body>
</html>