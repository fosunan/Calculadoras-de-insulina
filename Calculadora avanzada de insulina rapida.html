<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calculadora Dosis de Insulina - Hospital Universitario La Merced</title>
  <style>
    /* Reset básico para asegurar box-sizing */
    *, *::before, *::after {
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 1rem auto;
      padding: 0 1rem;
      background-image: url('Imagen de fondo presentación.png'); /* IMAGEN DE FONDO */
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      background-color: #f9f9f9;
      color: #333;
      font-size: 1em;
    }
    h1, h2 {
      color: #008000;
      font-size: 1.8em;
      margin-top: 1.5rem;
      margin-bottom: 0.8rem;
    }
    h1 {
      text-align: center;
      font-size: 2.2em;
    }
    .hospital-info {
      text-align: center;
      margin-bottom: 1.5rem;
    }
    .hospital-info h2 {
        font-size: 1.5em;
        margin-bottom: 0.2em;
        color: #008000;
    }
    .hospital-info p {
        font-size: 0.9em;
        color: #555;
        margin-top: 0;
    }
    .main-title {
        text-align: center;
        font-size: 1.8em;
        color: #008000;
        /* Verde oscuro */
        font-weight: bold;
        margin-top: 1rem;
        margin-bottom: 1.5rem;
    }
    label {
      font-weight: bold;
      display: block;
      margin-top: 1em;
    }
    input[type=number], select, .input-text-styled {
      width: 100%;
      max-width: 200px;
      /* Incrementado para mejor pulsación en móvil */
      padding: 0.5em;
      margin-top: 0.2em;
      margin-bottom: 0.6em;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1em;
    }
    .checkbox-inline {
      display: inline-block;
      margin-right: 1.5em; /* Ajustado a em */
      font-size: 1em;
    }
    .checkbox-inline input {
      margin-right: 0.5em;
      vertical-align: middle;
    }
    #datosAyerContainer, #correccionRatioContainerMedio {
      background: #e6ffe6;
      border: 1px solid #99e699;
      padding: 1em;
      margin-top: 0.8em;
      border-radius: 6px;
    }
    button {
      margin-top: 1.2em;
      padding: 0.7em 1.2em;
      background-color: #008000;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 1.1em;
      cursor: pointer;
      width: auto;
      display: block;
    }
    button:hover {
      background-color: #005500;
    }
    .resultado {
      margin-top: 1.5em;
      font-size: 1.3em;
      font-weight: bold;
      color: #004d00;
    }
    .resultado-aviso {
        font-size: 0.9em;
        color: #cc0000;
        margin-top: 0.5em;
        font-weight: normal;
    }
    .resultado-aviso.alerta-correccion {
        color: orange;
    }
    pre.pasos {
      background: #e6ffe6;
      border: 1px solid #99e699;
      padding: 1em;
      white-space: pre-wrap;
      margin-top: 1em;
      border-radius: 6px;
      font-size: 0.9em;
      line-height: 1.4;
    }
    .pasos-correccion-ratio, .pasos-calculo-ratio-basico {
        background: #e6ffe6;
        border: 1px solid #99e699;
        padding: 1em;
        white-space: pre-wrap;
        margin-top: 1em;
        border-radius: 6px;
        font-size: 0.85em;
        line-height: 1.4;
    }
    .error-message {
      color: red;
      font-size: 0.85em;
      margin-top: -0.4em;
      margin-bottom: 0.4em;
      display: none;
    }
    .logo-container {
        text-align: center;
        margin-bottom: 1.5rem;
    }
    .logo-container img {
        max-width: 400px;
        height: auto;
        display: block;
        margin: 0 auto;
    }
    .disclaimer-text p {
        margin-bottom: 0.5em;
    }
    .aviso-extra {
        font-size: 0.95em;
        color: #555;
        margin-top: 1em;
        line-height: 1.4;
    }
    .mensaje-rojo {
        color: red;
        font-weight: bold;
        margin-top: 0.8em;
    }
    .mensaje-rojo-cursiva {
      color: red;
      font-style: italic;
      margin-top: -0.4em;
      margin-bottom: 0.4em;
      display: none;
    }
    /* Estilo para el mensaje de corrección alta en rojo y negrita */
    #correccionAltaAviso {
        color: red;
        font-weight: bold;
    }
    /* New style for hipoglucemia warning */
    #riesgoHipoglucemiaAviso {
        color: red;
        font-weight: bold;
    }
    .strong-black-text {
      color: black;
      font-weight: bold;
    }
    #emergenciaAviso {
      color: red;
      font-weight: bold;
      margin-top: 0.5em;
      display: none;
    }
    /* New style for exercise adjustment container */
    #ajusteDeporteContainer {
      background: #f0f8ff;
      border: 1px solid #add8e6;
      padding: 1em;
      margin-top: 0.8em;
      border-radius: 6px;
    }
    #ajusteDeporteContainer p {
        margin-bottom: 0.5em;
    }

    /* Estilos de los contenedores de ajuste copiados de 13e.txt */
    .ajuste-ejemplos {
        font-style: italic;
        font-size: 0.9em;
        line-height: 1.4;
        margin-top: 0.5em;
    }
    .input-error {
        border-color: red !important;
    }
    .footer-divider {
      border: 0;
      height: 1px;
      background-color: black;
      margin: 20px auto;
      max-width: 650px; /* Ancho para que coincida con los cuadros verdes */
    }
    .footer-text {
      text-align: center;
      color: #008000;
      font-weight: bold;
      margin-top: 10px;
      margin-bottom: 5px;
    }
    .footer-name {
      text-align: center;
      font-weight: bold;
      color: #333;
    }
    /* Estilo para el nuevo texto del cargo */
    .profession-info {
      text-align: center;
      font-weight: normal;
      font-size: 0.9em;
      color: #555;
      margin-top: 0;
    }

    /* Media Queries para pantallas pequeñas (smartphones) */
    @media (max-width: 600px) {
      body {
        font-size: 1.1em;
        padding: 0 0.8rem;
      }
      h1 {
        font-size: 1.8em;
      }
      h2 {
        font-size: 1.4em;
      }
      label, input[type=number], select { /* Aplicar a label y select también */
        font-size: 1.1em;
      }
      input[type=number], select {
        max-width: 100%;
        padding: 0.6em;
      }
      button {
        font-size: 1.1em;
        width: 100%;
        padding: 0.8em 1em;
      }
      .resultado {
        font-size: 1.2em;
      }
      pre.pasos, .pasos-correccion-ratio, .pasos-calculo-ratio-basico {
        font-size: 0.95em;
      }
      .checkbox-inline {
        display: block;
        margin-right: 0;
        margin-bottom: 0.5em;
      }
      .logo-container img {
        max-width: 150px;
      }
    }
  </style>
</head>
<body>

  <div class="logo-container">
    <img src="COLOR_3_TINTAS.jpg" alt="Logo Área de Gestión Sanitaria de Osuna" />
  </div>

  <div class="hospital-info">
    <h1>Hospital Universitario La Merced</h1>
    <h1 style="color: green;">CALCULADORA AVANZADA DE DOSIS DE INSULINA RÁPIDA</h1>

  </div>

  <div class="disclaimer-text">
    <p>Esta herramienta tiene como objetivo ayudar para el cálculo de la dosis de insulina rápida a administrar, simplificando operaciones complejas y ayudando a la persona con diabetes a aplicar lo aprendido durante su Educación Terapéutica en Diabetes.</p>
    <p>El uso correcto de esta calculadora parte del conocimiento adquirido en consulta y debe formar parte de una estrategia de autocuidado supervisada.</p>
  </div>

  <hr>

  <p><strong>Edición en pruebas. Versión 1b.</strong></p>

  <h2>1. Insulina y glucemia</h2>

  <label for="rapida">¿Cuántas unidades de insulina rápida se administra cada día en total? (de media en los últimos 2 días):</label>
  <input id="rapida" type="number" min="3" max="100" step="0.1" />
  <span class="error-message" id="errorRapida"></span>

  <label for="lenta">¿Cuántas unidades de insulina lenta se administra cada día en total? (de media en los últimos 2 días):</label>
  <input id="lenta" type="number" min="5" max="100" step="0.1" />
  <span class="error-message" id="errorLenta"></span>

  <label for="glucemiaActual">¿Qué glucemia tiene ANTES de esta comida (mg/dL):</label>
  <input id="glucemiaActual" type="text" class="input-text-styled" />
  <span class="error-message" id="errorGlucemiaActual"></span>
  <div id="emergenciaAviso" class="mensaje-rojo" style="display:none;">
    ¡ATENCIÓN: Valores inferiores a 55 mg/dl o superiores a 450, o los valores “LO” o “HI” pueden ser una EMERGENCIA DIABETOLÓGICA. Confirme la glucemia (haga una prueba capilar para comprobar el resultado). Solucione esta situación cuanto antes o llame a los servicios de emergencia (112).
  </div>

  <label for="flechaGlucemia">Si usted tiene Monitorización, indique cómo está la flecha:</label>
  <select id="flechaGlucemia">
    <option value="estable">Estable</option>
    <option value="ascenso_lento">Ascenso lento</option>
    <option value="ascenso_rapido">Ascenso rápido</option>
    <option value="descenso_lento">Descenso lento</option>
    <option value="descenso_rapido">Descenso rápido</option>
  </select>

  <label for="glucemiaObjetivo">¿Cuál es la glucemia que quiere tener DESPUÉS de 3 horas? (mg/dL) (Por defecto 120). Por la noche, o en personas muy sensibles o con fragilidad, puede indicarse 150 o un valor mayor):</label>
  <input id="glucemiaObjetivo" type="number" min="100" max="180" step="1" value="120" />
  <span class="error-message" id="errorGlucemiaObjetivo"></span>

  <hr>

  <h2>2. Ratio</h2>

  <label for="ratioInput">Ratio Insulina/Carbohidratos (unidades de insulina por ración), si la conoce, indíquela:</label>
  <p style="font-style: italic; font-weight: normal; font-size: 0.9em; margin-top: 0.5em; margin-bottom: 0.5em;">Recuerde que los datos de la ratio del desayuno de ayer servirán como base para el desayuno de hoy y así sucesivamente. No utilice los datos de ratio de una comida para otra distinta.</p>
  <input id="ratioInput" type="number" min="0" max="6" step="0.01" />
  <span class="error-message" id="errorRatioInput"></span>
  <span class="mensaje-rojo-cursiva" id="avisoRatioCero" style="display:none;">Si no se indica un valor de ratio o éste es 0, solo obtendrá un ajuste de corrección.</span>
  <br />
  <label class="checkbox-inline">
    <input type="checkbox" id="noConozcoRatio" onchange="toggleRatioInput()" />
    1. AJUSTE BÁSICO (Basado en una PAUTA):
    </label>
    <p>      Ejemplo: No conozco la ratio. Necesito ayuda para calcularla.</p>   
  </label>


  <label class="checkbox-inline">
    <input type="checkbox" id="necesitoCorregirRatioMedio" onchange="toggleCorreccionRatio('Medio')" />
    2. AJUSTE AVANZADO (Basado en Ratio y Raciones): 
    </label>
    <p>      Ejemplo: Conozco mi ratio para esta comida, pero no funcionó ayer. Necesito ayuda para corregirla.</p>   

  </label>

  <br />

  <div id="datosAyerContainer" style="display:none;">
    <p>Este apartado está pensado para iniciarse en los cálculos de ratio de insulina por ración. Este valor deberá ir ajustándose con el paso de los días. En su cálculo no se tiene en cuenta, composición de la comida, deporte,... </p>
    <p>El objetivo de la ratio insulina/carbohidratos es lograr que, aproximadamente tres horas después de la administración de insulina rápida, los valores de glucemia se encuentren en niveles similares a los registrados antes de la ingesta. Esto indicaría que la insulina administrada y los hidratos de carbono consumidos han ejercido un efecto compensatorio.</p>

    <label for="glucemiaPreviaAyer">Ayer, ¿Cuál era la glucemia ANTES de esa comida:</label>
    <input id="glucemiaPreviaAyer" type="number" min="55" max="450" step="1" value="120"/>
    <span class="error-message" id="errorGlucemiaPreviaAyer"></span>

    <label for="glucemia3hAyerNoConozco">Ayer, ¿Cuál era la glucemia 3 horas DESPUÉS?</label>
    <input id="glucemia3hAyerNoConozco" type="number" min="55" max="450" step="1" value="120"/>
    <span class="error-message" id="errorGlucemia3hAyerNoConozco"></span>

    <label for="insulinaAyer">¿Cuántas UNIDADES de insulina rápida se administra para esa comida?</label>
     <p><strong>No incluya las unidades de corrección.</strong></p>   

    <input id="insulinaAyer" type="number" min="0" step="0.1" />
    <span class="error-message" id="errorInsulinaAyer"></span>

    <label for="racionesAyer">¿Cuántas RACIONES (de 10 g HC) tomó ayer para esa comida?</label>
    <input id="racionesAyer" type="number" min="0" max="25" step="0.1" />
    <span class="error-message" id="errorRacionesAyer"></span>

    <button type="button" onclick="calcularRatioNoConozco()">Calcular ratio</button>
    <div id="resultadoRatioNoConozco" style="margin-top: 1rem; font-weight: bold; color: #004d00;"></div>
    <div class="pasos-calculo-ratio-basico" id="pasosCalculoRatioNoConozco" style="display:none;"></div>
</div>

  <div id="correccionRatioContainerMedio" style="display:none; margin-top:1rem;">
    <p><u><b>Para corregir la ratio de ayer (con ajuste avanzado), introduzca los siguientes datos:</b></u></p>
    <p style="font-style: italic;">ATENCIÓN: Si ayer, antes o después de esta misma comida (desayuno, comida, merienda o cena) realizó deporte o trabajo físico, tenga en cuenta que estos cálculos pueden no ser exactos, debido a la dificultad para cuantificar el gasto de glucosa.</p>
    <br>

    <label for="glucemia3hAyerMedio">¿Qué glucemia tuvo ayer, 3 horas DESPUÉS de esa comida?</label>
    <input id="glucemia3hAyerMedio" type="number" min="55" max="450" step="1" />
    <span class="error-message" id="errorGlucemia3hAyerMedio"></span>

    <label for="racionesComidaAyerMedio">¿Cuántas RACIONES tomó ayer en esa comida? (10 g HC):</label>
    <input id="racionesComidaAyerMedio" type="number" min="0" max="25" step="0.1" />
    <span class="error-message" id="errorRacionesComidaAyerMedio"></span>

    <label for="ratioUtilizadaAyerMedio">¿Cuál fue la RATIO utilizada ayer? (Insulina/Ración):</label>
    <input id="ratioUtilizadaAyerMedio" type="number" min="0" max="10" step="0.01" />
    <span class="error-message" id="errorRatioUtilizadaAyerMedio"></span>

    <label>¿Tuvo HIPOGLUCEMIA/S en las 3 horas siguientes a la administración de la insulina de esa comida?</label>
    <select id="hipoglucemiaAyerMedio" onchange="toggleRacionesHipoglucemia('Medio')">
      <option value="no" selected>No</option>
      <option value="si">Sí</option>
   </select>

    <div id="racionesHipoglucemiaContainerMedio" style="display:none; margin-top:0.5rem;">
      <label for="racionesParaHipoglucemiaMedio">Raciones (10 g HC) que tomó para revertir hipoglucemia:</label>
      <input id="racionesParaHipoglucemiaMedio" type="number" min="0.5" max="6" step="0.1" />
      <span class="error-message" id="errorRacionesHipoglucemiaMedio"></span>
    </div>
    
    <button type="button" onclick="calcularCorreccionRatio('Medio')">Calcular ratio corregida</button>

    <div id="resultadoCorreccionRatioMedio" style="margin-top: 1rem; font-weight: bold; color: #008000;"></div>
    <br>
    <div class="pasos-correccion-ratio" id="pasosCorreccionRatioMedio" style="display:none;"></div>
  </div>

  <hr>

  <h2>3. Comida y actividad</h2>

  <label for="racionesComidaActual">¿Cuántas Raciones va a comer en esta comida? (10 g HC):</label>
  <input id="racionesComidaActual" type="number" min="0" max="25" step="0.1" />
  <span class="error-message" id="errorRacionesComidaActual"></span>
  <span class="mensaje-rojo-cursiva" id="avisoRacionesCero">Si no se indica un valor de raciones o éste es 0, solo obtendrá un ajuste de corrección.</span>

  <label for="comidaComposicion">¿Cómo es la composición de esta comida?</label>
  <select id="comidaComposicion" onchange="toggleAjusteComposicion()">
    <option value="normal" selected>Normal</option>
    <option value="liviana">Liviana</option>
    <option value="pesada">Pesada</option>
  </select>

  <div id="ajusteLivianaContainer" style="display:none;">
    <p>Se trata de una comida con menos proteína y/o grasa de lo habitual. Para evitar una hipoglucemia, es recomendable RESTAR una dosis de insulina entre 0.5 y 3 unidades de insulina para compensarlo.</p>
    <label for="ajusteLiviana">Ajuste de dosis a REDUCIR (Unidades):</label>
    <input id="ajusteLiviana" type="number" min="0.5" max="3" step="0.5" />
    <span class="error-message" id="errorAjusteLiviana">Introduce un valor válido entre 0.5 y 3.</span>
  </div>

  <div id="ajustePesadaContainer" style="display:none;">
    <p>Se trata de una comida con más proteína y/o grasa de lo habitual. Para evitar una hiperglucemia de forma tardía, es recomendable SUMAR una dosis de insulina entre 0.5 y 3 unidades de insulina para compensarlo.</p>
    <label for="ajustePesada">Ajuste de dosis (Unidades):</label>
    <input id="ajustePesada" type="number" min="0.5" max="3" step="0.5" />
    <span class="error-message" id="errorAjustePesada">Introduce un valor válido entre 0.5 y 3.</span>
  </div>


  <label for="deporteAntes">¿Ha realizado deporte/trabajo físico antes de esta comida?</label>
  <select id="deporteAntes" onchange="toggleAjusteDeporteAntes()">
    <option value="no" selected>No</option>
    <option value="si">Sí</option>
  </select>

  <div id="ajusteDeporteAntesContainer" style="display:none;">
    <p>El ejercicio aumenta la sensibilidad de tu cuerpo a la insulina. </p>
    <p>Ajuste recomendado: REDUCE la dosis entre 1 y 4 unidades. Elige el valor en función de la intensidad y la duración del ejercicio. Por ejemplo:</p>
    <div class="ajuste-ejemplos">
      <p>Ejercicio ligero o corto (paseo, estiramientos):
        <br>
        Reduce la dosis en 1 unidad. </p>
      <p>Ejercicio moderado (correr, nadar, bicicleta): Reduce
        <br>
        la dosis en 2 unidades. </p>
      <p>Ejercicio intenso o prolongado (deportes de equipo,
        <br>
        gimnasio): Reduce la dosis en 3 a 4 unidades. </p>
    </div>
    <label for="ajusteDeporteAntes">Ajuste de dosis a REDUCIR (Unidades):</label>
    <input id="ajusteDeporteAntes" type="number" min="0.5" max="5" step="0.5" />
    <span class="error-message" id="errorAjusteDeporteAntes">Introduce un valor válido entre 0.5 y 5.</span>
  </div>


  <label for="deporteDespues">¿Va a hacer deporte/trabajo físico después de esta comida?</label>
  <select id="deporteDespues" onchange="toggleAjusteDeporteDespues()">
    <option value="no" selected>No</option>
    <option value="si">Sí</option>
  </select>

  <div id="ajusteDeporteDespuesContainer" style="display:none;">
    <p>La insulina que te inyectes ahora actuará durante las próximas 3 horas, si en este tiempo realizas un consumo extra de glucosa debido al ejercicio o trabajo intenso, puedes tener una hipoglucemia. </p>
    <p>Ajuste recomendado: REDUCE la dosis entre 1 y 4 unidades. Elige el valor en función de la intensidad y la duración del ejercicio. Por ejemplo:</p>
    <div class="ajuste-ejemplos">
      <p>Ejercicio ligero o corto (paseo, estiramientos):
        <br>
        Reduce la dosis en 1 unidad. </p>
      <p>Ejercicio moderado (correr, nadar, bicicleta): Reduce
        <br>
        la dosis en 2 unidades. </p>
      <p>Ejercicio intenso o prolongado (deportes de equipo,
        <br>
        gimnasio): Reduce la dosis en 3 a 4 unidades. </p>
    </div>
    <label for="ajusteDeporteDespues">Ajuste de dosis a REDUCIR (Unidades):</label>
    <input id="ajusteDeporteDespues" type="number" min="0.5" max="5" step="0.5" />
    <span class="error-message" id="errorAjusteDeporteDespues">Introduce un valor válido entre 0.5 y 5.</span>
  </div>


  <label for="hipoglucemiaActual">¿Ayer tuvo usted hipoglucemia después de esta comida?:</label>
  <select id="hipoglucemiaActual">
    <option value="no">No</option>
    <option value="si">Sí</option>
  </select>

  <hr>

  <h2>4. Cálculos</h2>
  <button onclick="calcularInsulina()">Calcular dosis de insulina</button>

  <div class="resultado" id="resultado"></div>
  <p class="mensaje-rojo" id="validationErrorAviso" style="display:none;">Revise los valores introducidos, puede que no sean válidos.</p>
    <p class="resultado-aviso" id="dosisAltaAviso" style="display:none;">⚠️ Esta es una dosis alta para usted. Por favor, revise los datos introducidos.</p>
  <p class="resultado-aviso" id="correccionAltaAviso" style="display:none;">⚠️ Esta es una dosis alta para usted. Por favor, revise los datos introducidos.</p>
  <p id="riesgoHipoglucemiaAviso" style="display:none;">Mensaje de riesgo de hipoglucemia</p>
  <p class="mensaje-rojo" id="noRegistroAviso" style="display:none;">No ha indicado el ratio y/o raciones de esta comida. El resultado obtenido solo es útil si va a corregir su nivel actual de glucosa sin comer. </p>
  <p class="strong-black-text">Los resultados ofrecidos son únicamente orientativos y no sustituyen la consulta ni las indicaciones de un profesional sanitario.</p>
  <p class="aviso-extra">Puede que esta dosis de insulina necesite algún ajuste extra como es el caso de situaciones por enfermedad (fiebre, diarrea,...), algunos tratamientos (corticoides,...), menstruación,... que pueden hacer variar estos cálculos. Consulta con tu profesional sanitario.</p>
  <pre class="pasos" id="pasos"></pre>
  
  <hr class="footer-divider">
  <p class="footer-text">DESARROLLADO POR:</p>
  <p class="footer-name">Francisco José Osuna Navarro</p>
  <p class="profession-info">Enfermero de la consulta EPA de Diabetes</p>
  <button onclick="window.location.href='https://fosunan.github.io/Calculadoras-de-insulina/'">Volver al Menú Principal</button>
  <script>
    // Función genérica para validar input y mostrar mensaje de error
    function validateInput(inputId, errorId, condition) {
      const input = document.getElementById(inputId);
      const errorSpan = document.getElementById(errorId);
      const min = input.getAttribute('min');
      const max = input.getAttribute('max');
      if (!condition(input.value)) {
        input.classList.add('input-error');
        if (min !== null && max !== null) {
            errorSpan.textContent = `Introduce un valor válido entre ${min} y ${max}.`;
        } else if (min !== null) {
            errorSpan.textContent = `Introduce un valor válido mayor o igual a ${min}.`;
        } else if (max !== null) {
            errorSpan.textContent = `Introduce un valor válido menor o igual a ${max}.`;
        } else {
            errorSpan.textContent = `Introduce un valor válido.`;
        }
        errorSpan.style.display = 'block';
        return false;
      } else {
        input.classList.remove('input-error');
        errorSpan.style.display = 'none';
        return true;
      }
    }

    // Funciones de validación específicas
    const isPositiveNumber = (value) => parseFloat(value) > 0;
    const isNonNegativeNumber = (value) => parseFloat(value) >= 0;
    
    // Función de validación de rango genérica
    function isWithinRange(value, min, max) {
      const numValue = parseFloat(value);
      return !isNaN(numValue) && numValue >= min && numValue <= max;
    }

    // Redondeo a la media unidad más cercana
    function roundToHalf(num) {
        return Math.round(num * 2) / 2;
    }

    // New function for ratio display (1 decimal place without rounding)
    function formatRatio(num) {
        return num.toFixed(1);
    }

    // Helper to clear inputs and hide errors in a container
    function clearInputsAndResults(containerId) {
        const container = document.getElementById(containerId);
        if (!container) return;

        // Clear input values
        container.querySelectorAll('input[type="number"]').forEach(input => {
            input.value = '';
        });
        // Reset select values to first option if applicable, or default
        container.querySelectorAll('select').forEach(select => {
            select.selectedIndex = 0;
        });
        // Hide error messages
        container.querySelectorAll('.error-message').forEach(errorSpan => {
            errorSpan.style.display = 'none';
        });
        // Hide and clear results/steps
        container.querySelectorAll('[id^="resultado"], [id^="pasos"]').forEach(el => {
            el.textContent = '';
            el.style.display = 'none';
        });
        // Special clear for hipoglucemia containers
        if (containerId === 'correccionRatioContainerMedio') {
            document.getElementById(`racionesHipoglucemiaContainerMedio`).style.display = 'none';
        }
    }

    // Mostrar/ocultar inputs según checkbox "No conozco la ratio"
    function toggleRatioInput() {
      const checkbox = document.getElementById('noConozcoRatio');
      const datosAyerContainer = document.getElementById('datosAyerContainer');
      const ratioInput = document.getElementById('ratioInput');
      const necesitaCorregirRatioMedio = document.getElementById('necesitoCorregirRatioMedio');
      const correccionRatioContainerMedio = document.getElementById('correccionRatioContainerMedio');
      const pasosCalculoRatioNoConozco = document.getElementById('pasosCalculoRatioNoConozco');
      if (checkbox.checked) {
        datosAyerContainer.style.display = 'block';
        ratioInput.value = '';
        // Clear and hide other sections
        necesitoCorregirRatioMedio.checked = false;
        clearInputsAndResults('correccionRatioContainerMedio');
        correccionRatioContainerMedio.style.display = 'none';
        document.getElementById('resultadoRatioNoConozco').textContent = '';
        pasosCalculoRatioNoConozco.style.display = 'none';
        pasosCalculoRatioNoConozco.textContent = '';
      } else {
        clearInputsAndResults('datosAyerContainer');
        datosAyerContainer.style.display = 'none';
        ratioInput.disabled = false;
      }
      document.getElementById('errorRatioInput').style.display = 'none';
    }

    // Mostrar/ocultar inputs según checkbox "Necesito corregir mi ratio conocida"
    function toggleCorreccionRatio(tipoAjuste) {
      const checkboxMedio = document.getElementById('necesitoCorregirRatioMedio');
      const contenedorMedio = document.getElementById('correccionRatioContainerMedio');
      const noConozcoRatio = document.getElementById('noConozcoRatio');
      const datosAyerContainer = document.getElementById('datosAyerContainer');
      const ratioInput = document.getElementById('ratioInput');
      // Clear and hide "1. AJUSTE BÁSICO" section
      noConozcoRatio.checked = false;
      clearInputsAndResults('datosAyerContainer');
      datosAyerContainer.style.display = 'none';
      // This function is called onchange, so checkboxMedio.checked reflects the *new* state
      if (checkboxMedio.checked) { // User just checked "2. AJUSTE AVANZADO"
        contenedorMedio.style.display = 'block';
      } else { // User just unchecked "2. AJUSTE AVANZADO"
        contenedorMedio.style.display = 'none';
        clearInputsAndResults('correccionRatioContainerMedio');
        ratioInput.value = ''; // Clear the main ratio input
      }
      document.getElementById('errorRatioInput').style.display = 'none';
    }

    // Mostrar/ocultar input para raciones para hipoglucemia
    function toggleRacionesHipoglucemia(tipoAjuste) {
      const select = document.getElementById(`hipoglucemiaAyer${tipoAjuste}`);
      const contenedor = document.getElementById(`racionesHipoglucemiaContainer${tipoAjuste}`);
      const inputRaciones = document.getElementById(`racionesParaHipoglucemia${tipoAjuste}`);
      const errorRaciones = document.getElementById(`errorRacionesHipoglucemia${tipoAjuste}`);
      if (select.value === 'si') {
        contenedor.style.display = 'block';
      } else {
        contenedor.style.display = 'none';
        inputRaciones.value = '';
        errorRaciones.style.display = 'none';
      }
    }

    // Funciones para mostrar/ocultar contenedores de ajuste (copiadas de 13e)
    function toggleAjusteComposicion() {
      const select = document.getElementById('comidaComposicion');
      document.getElementById('ajusteLivianaContainer').style.display = 'none';
      document.getElementById('ajustePesadaContainer').style.display = 'none';
      if (select.value === 'liviana') {
        document.getElementById('ajusteLivianaContainer').style.display = 'block';
      } else if (select.value === 'pesada') {
        document.getElementById('ajustePesadaContainer').style.display = 'block';
      }
    }
    function toggleAjusteDeporteAntes() {
      const select = document.getElementById('deporteAntes');
      document.getElementById('ajusteDeporteAntesContainer').style.display = (select.value === 'si') ? 'block' : 'none';
    }
    function toggleAjusteDeporteDespues() {
      const select = document.getElementById('deporteDespues');
      document.getElementById('ajusteDeporteDespuesContainer').style.display = (select.value === 'si') ? 'block' : 'none';
    }

    // Calculate ratio when "No conozco ratio" is selected
    function calcularRatioNoConozco() {
      let isValid = true;
      // Validate inputs
      const rapida = parseFloat(document.getElementById('rapida').value);
      isValid = validateInput('rapida', 'errorRapida', value => isWithinRange(value, 3, 100)) && isValid;
      const lenta = parseFloat(document.getElementById('lenta').value);
      isValid = validateInput('lenta', 'errorLenta', value => isWithinRange(value, 5, 100)) && isValid;
      isValid = validateInput('glucemiaPreviaAyer', 'errorGlucemiaPreviaAyer', value => isWithinRange(value, 55, 450)) && isValid;
      isValid = validateInput('glucemia3hAyerNoConozco', 'errorGlucemia3hAyerNoConozco', value => isWithinRange(value, 55, 450)) && isValid;
      // Special validation for 'insulinaAyer' based on 'rapida'
      const insulinaAyerInput = document.getElementById('insulinaAyer');
      const insulinaAyerValue = parseFloat(insulinaAyerInput.value);
      const errorInsulinaAyerSpan = document.getElementById('errorInsulinaAyer');
      if (insulinaAyerValue < 0 || insulinaAyerValue > rapida || isNaN(insulinaAyerValue)) {
        insulinaAyerInput.classList.add('input-error');
        errorInsulinaAyerSpan.textContent = `Introduce un valor válido entre 0 y ${rapida}.`;
        errorInsulinaAyerSpan.style.display = 'block';
        isValid = false;
      } else {
        insulinaAyerInput.classList.remove('input-error');
        errorInsulinaAyerSpan.style.display = 'none';
      }
      isValid = validateInput('racionesAyer', 'errorRacionesAyer', value => isWithinRange(value, 0, 25)) && isValid;
      if (!isValid) {
        document.getElementById('resultadoRatioNoConozco').textContent = 'Por favor, corrija los errores para calcular la ratio.';
        document.getElementById('pasosCalculoRatioAyer').style.display = 'none';
        return;
      }
      
      const glucemiaPreviaAyer = parseFloat(document.getElementById('glucemiaPreviaAyer').value);
      const glucemia3hAyerNoConozco = parseFloat(document.getElementById('glucemia3hAyerNoConozco').value);
      const insulinaAyer = parseFloat(document.getElementById('insulinaAyer').value);
      const racionesAyer = parseFloat(document.getElementById('racionesAyer').value);
      const totalInsulina = rapida + lenta;
      const constanteCorreccion = 1800; // Hard-coded value
      const factorCorreccion = totalInsulina > 0 ? constanteCorreccion / totalInsulina : 0; // Avoid division by zero
      
      const pasosContainer = document.getElementById('pasosCalculoRatioNoConozco');
      let pasosTexto = `Pasos para calcular la ratio:\n\n`;
      let nuevaRatio = 0;
      
      const correccionGlucemiaAyer = glucemia3hAyerNoConozco - glucemiaPreviaAyer;
      pasosTexto += `1. Desajuste de glucemia alcanzado ayer a las 3 horas: Glucemia posterior a las 3 horas (${glucemia3hAyerNoConozco.toFixed(0)} mg/dL) - Glucemia previa (${glucemiaPreviaAyer.toFixed(0)} mg/dL) = ${correccionGlucemiaAyer.toFixed(0)} mg/dL.\n`;
      
      let correccionUnidadesAyer = 0;
      if (factorCorreccion > 0) {
        correccionUnidadesAyer = correccionGlucemiaAyer / factorCorreccion;
        pasosTexto += `2. Ajuste de corrección necesario ayer: Corrección glucemia de ayer (${correccionGlucemiaAyer.toFixed(0)} mg/dL) / Factor de Corrección de Insulina (${factorCorreccion.toFixed(2)} mg/dL/unidad) = ${correccionUnidadesAyer.toFixed(2)} Unidades.\n`;
      } else {
        pasosTexto += `2. No se puede calcular la Corrección unidades de ayer porque el Factor de Corrección de Insulina es cero.\n`;
      }
      
      const insulinaNetaAyer = insulinaAyer - correccionUnidadesAyer;
      pasosTexto += `3. Insulina neta por carbohidratos: ${insulinaAyer.toFixed(1)} (Insulina total) - ${correccionUnidadesAyer.toFixed(2)} (Corrección de glucemia) = ${insulinaNetaAyer.toFixed(2)} Unidades.\n`;
      
      if (racionesAyer > 0) {
        nuevaRatio = insulinaNetaAyer / racionesAyer;
        pasosTexto += `4. Nueva Ratio: ${insulinaNetaAyer.toFixed(2)} (Insulina neta) / ${racionesAyer.toFixed(1)} (Raciones) = ${formatRatio(nuevaRatio)} Unidades/Ración.\n`;
        document.getElementById('resultadoRatioNoConozco').innerHTML = '<span style="color: #008000; font-weight: bold;">La ratio necesaria ayer fue de ' + formatRatio(nuevaRatio) + ' Unidades/Ración.</span>';
      } else {
          document.getElementById('resultadoRatioNoConozco').innerHTML = '<span style="color: red; font-weight: bold;">No se puede calcular la ratio si las raciones son 0. Solo se puede aplicar el ajuste de corrección por glucemia.</span>';
      }
      
      pasosContainer.innerHTML = pasosTexto.replace(/\n/g, '<br>');
      pasosContainer.style.display = 'block';
    }

 // Function to calculate and display the corrected ratio (for AJUSTE AVANZADO)
    function calcularCorreccionRatio(tipoAjuste) {
      // Check if all inputs are valid before proceeding
      let isValid = true;
      document.getElementById('errorGlucemia3hAyerMedio').style.display = 'none';
      document.getElementById('errorRacionesComidaAyerMedio').style.display = 'none';
      document.getElementById('errorRatioUtilizadaAyerMedio').style.display = 'none';
      document.getElementById('errorRacionesHipoglucemiaMedio').style.display = 'none';
      
      const glucemia3hAyerMedio = parseFloat(document.getElementById('glucemia3hAyerMedio').value);
      isValid = validateInput('glucemia3hAyerMedio', 'errorGlucemia3hAyerMedio', value => isWithinRange(value, 55, 450)) && isValid;
      
      const racionesComidaAyerMedio = parseFloat(document.getElementById('racionesComidaAyerMedio').value);
      isValid = validateInput('racionesComidaAyerMedio', 'errorRacionesComidaAyerMedio', value => isWithinRange(value, 0, 25)) && isValid;
      
      const ratioUtilizadaAyerMedio = parseFloat(document.getElementById('ratioUtilizadaAyerMedio').value);
      isValid = validateInput('ratioUtilizadaAyerMedio', 'errorRatioUtilizadaAyerMedio', value => isWithinRange(value, 0, 10)) && isValid;
      
      const hipoglucemiaAyerMedio = document.getElementById('hipoglucemiaAyerMedio').value;
      let racionesParaHipoglucemiaMedio = 0;
      if (hipoglucemiaAyerMedio === 'si') {
        racionesParaHipoglucemiaMedio = parseFloat(document.getElementById('racionesParaHipoglucemiaMedio').value);
        isValid = validateInput('racionesParaHipoglucemiaMedio', 'errorRacionesHipoglucemiaMedio', value => isWithinRange(value, 0.5, 6)) && isValid;
      }
      
      if (!isValid) {
        document.getElementById('resultadoCorreccionRatioMedio').textContent = 'Por favor, corrija los errores para calcular la ratio corregida.';
        document.getElementById('pasosCorreccionRatioMedio').style.display = 'none';
        return;
      }
      
      const glucemiaObjetivo = parseFloat(document.getElementById('glucemiaObjetivo').value);
      const totalInsulina = parseFloat(document.getElementById('rapida').value) + parseFloat(document.getElementById('lenta').value);
      const constanteCorreccion = 1800;
      const factorCorreccion = totalInsulina > 0 ?
      constanteCorreccion / totalInsulina : 0;
      
      const diferenciaGlucemia = glucemia3hAyerMedio - glucemiaObjetivo;
      let correccionUnidades = factorCorreccion > 0 ?
      diferenciaGlucemia / factorCorreccion : 0;
      
      let racionesNetas = racionesComidaAyerMedio;
      if (hipoglucemiaAyerMedio === 'si') {
        racionesNetas += racionesParaHipoglucemiaMedio;
      }
      
      let insulinaTotal = (ratioUtilizadaAyerMedio * racionesComidaAyerMedio) + correccionUnidades;
      let nuevaRatio = racionesNetas > 0 ? insulinaTotal / racionesNetas : 0;
      if (hipoglucemiaAyerMedio === 'si') {
          // Special case for hipoglucemia, if the new ratio is higher than old, reduce it by 0.5
          if (nuevaRatio > ratioUtilizadaAyerMedio) {
              nuevaRatio = Math.max(0, nuevaRatio - 0.5);
          }
      }
      
      // Build the steps text
      let pasosTexto = `Pasos para corregir la ratio:\n\n`;
      pasosTexto += `1. Glucemia objetivo a las 3 horas: ${glucemiaObjetivo.toFixed(0)} mg/dL.\n`;
      pasosTexto += `2. Diferencia de glucemia: ${glucemia3hAyerMedio.toFixed(0)} (Glucemia después de 3h) - ${glucemiaObjetivo.toFixed(0)} (Objetivo) = ${diferenciaGlucemia.toFixed(0)} mg/dL.\n`;
      pasosTexto += `3. Factor de Corrección: 1800 / ${totalInsulina.toFixed(1)} (Insulina Total) = ${factorCorreccion.toFixed(2)} mg/dL/unidad.\n`;
      pasosTexto += `4. Unidades de corrección: ${diferenciaGlucemia.toFixed(0)} (Diferencia Glucemia) / ${factorCorreccion.toFixed(2)} (Factor de Corrección) = ${correccionUnidades.toFixed(2)} Unidades.\n`;
      pasosTexto += `5. Raciones totales: ${racionesComidaAyerMedio.toFixed(1)} (Raciones tomadas) + ${racionesParaHipoglucemiaMedio.toFixed(1)} (Raciones para Hipoglucemia) = ${racionesNetas.toFixed(1)} Raciones.\n`;
      pasosTexto += `6. Insulina total administrada ayer: ${ratioUtilizadaAyerMedio.toFixed(1)} (Ratio utilizada) * ${racionesComidaAyerMedio.toFixed(1)} (Raciones tomadas) + ${correccionUnidades.toFixed(2)} (Unidades de corrección) = ${insulinaTotal.toFixed(2)} Unidades.\n`;
      pasosTexto += `7. Nueva Ratio Corregida: ${insulinaTotal.toFixed(2)} (Insulina total) / ${racionesNetas.toFixed(1)} (Raciones totales) = ${nuevaRatio.toFixed(2)} Unidades/Ración.\n`;
      document.getElementById('resultadoCorreccionRatioMedio').innerHTML = '<span style="color: #008000; font-weight: bold;">La nueva ratio corregida es de ' + nuevaRatio.toFixed(1) + ' Unidades/Ración.</span>';
      document.getElementById('pasosCorreccionRatioMedio').innerHTML = pasosTexto.replace(/\n/g, '<br>');
      document.getElementById('pasosCorreccionRatioMedio').style.display = 'block';

      // Vuelca la nueva ratio al campo principal
      document.getElementById('ratioInput').value = nuevaRatio.toFixed(1);
    }   

    // Main calculation function
    function calcularInsulina() {
      // Clear previous results and errors first
      document.getElementById('resultado').innerHTML = '';
      document.getElementById('pasos').style.display = 'none';
      document.getElementById('dosisAltaAviso').style.display = 'none';
      document.getElementById('correccionAltaAviso').style.display = 'none';
      document.getElementById('riesgoHipoglucemiaAviso').style.display = 'none';
      document.getElementById('noRegistroAviso').style.display = 'none';
      document.getElementById('validationErrorAviso').style.display = 'none';
      
      // **New emergency check at the start of the function**
      const glucemiaActualInput = document.getElementById('glucemiaActual');
      const glucemiaActualValue = glucemiaActualInput.value.trim().toUpperCase();
      const isEmergencyValue = glucemiaActualValue === 'LO' || glucemiaActualValue === 'HI' || parseFloat(glucemiaActualValue) < 55 || parseFloat(glucemiaActualValue) > 450;
      
      // Hide other messages and show only the emergency one
      if (isEmergencyValue) {
        document.getElementById('emergenciaAviso').style.display = 'block';
        document.getElementById('emergenciaAviso').scrollIntoView({ behavior: 'smooth' });
        glucemiaActualInput.classList.add('input-error');
        return;
      } else {
        document.getElementById('emergenciaAviso').style.display = 'none';
        glucemiaActualInput.classList.remove('input-error');
      }

      let isValid = true;
      // Validate all required inputs
      const rapida = parseFloat(document.getElementById('rapida').value);
      isValid = validateInput('rapida', 'errorRapida', value => isWithinRange(value, 3, 100)) && isValid;
      const lenta = parseFloat(document.getElementById('lenta').value);
      isValid = validateInput('lenta', 'errorLenta', value => isWithinRange(value, 5, 100)) && isValid;
      const glucemiaActual = parseFloat(glucemiaActualValue);
      isValid = validateInput('glucemiaActual', 'errorGlucemiaActual', value => isWithinRange(value, 55, 450)) && isValid;

      const glucemiaObjetivo = parseFloat(document.getElementById('glucemiaObjetivo').value);
      isValid = validateInput('glucemiaObjetivo', 'errorGlucemiaObjetivo', value => isWithinRange(value, 100, 180)) && isValid;

      const racionesComidaActual = parseFloat(document.getElementById('racionesComidaActual').value);
      isValid = validateInput('racionesComidaActual', 'errorRacionesComidaActual', value => isWithinRange(value, 0, 25)) && isValid;
      if (racionesComidaActual === 0) {
        document.getElementById('avisoRacionesCero').style.display = 'block';
      } else {
        document.getElementById('avisoRacionesCero').style.display = 'none';
      }

      const ratioInput = document.getElementById('ratioInput');
      const noConozcoRatio = document.getElementById('noConozcoRatio').checked;
      const necesitoCorregirRatioMedio = document.getElementById('necesitoCorregirRatioMedio').checked;

      let ratioInsulina;
      if (noConozcoRatio) {
          const nuevaRatioNoConozco = parseFloat(document.getElementById('resultadoRatioNoConozco').textContent.match(/\d+\.\d+/));
          if (isNaN(nuevaRatioNoConozco)) {
              isValid = false;
              document.getElementById('errorRatioInput').textContent = 'La ratio no ha sido calculada. Por favor, calcule la ratio o introduzca un valor.';
              document.getElementById('errorRatioInput').style.display = 'block';
          } else {
              ratioInsulina = nuevaRatioNoConozco;
          }
      } else if (necesitoCorregirRatioMedio) {
          const nuevaRatioCorregida = parseFloat(document.getElementById('resultadoCorreccionRatioMedio').textContent.match(/\d+\.\d+/));
          if (isNaN(nuevaRatioCorregida)) {
              isValid = false;
              document.getElementById('errorRatioInput').textContent = 'La ratio no ha sido corregida. Por favor, calcule la ratio corregida o introduzca un valor.';
              document.getElementById('errorRatioInput').style.display = 'block';
          } else {
              ratioInsulina = nuevaRatioCorregida;
          }
      } else {
        isValid = validateInput('ratioInput', 'errorRatioInput', value => isWithinRange(value, 0, 6)) && isValid;
        ratioInsulina = parseFloat(ratioInput.value);
      }

// AVISOS
      if (ratioInsulina === 0 || racionesComidaActual === 0) {
        document.getElementById('noRegistroAviso').style.display = 'block';
      } else {
        document.getElementById('noRegistroAviso').style.display = 'none';
      }

      if ((isNaN(ratioInsulina) || ratioInsulina === 0) && racionesComidaActual > 0) {
        document.getElementById('avisoRatioCero').style.display = 'block';
      } else {
        document.getElementById('avisoRatioCero').style.display = 'none';
      }

      // Vuelve a validar después de obtener los valores finales
      isValid = validateInput('ratioInput', 'errorRatioInput', value => isWithinRange(value, 0, 6)) && isValid;
      isValid = validateInput('racionesComidaActual', 'errorRacionesComidaActual', value => isWithinRange(value, 0, 25)) && isValid;

      // Vuelve a validar después de obtener los valores finales
      isValid = validateInput('ratioInput', 'errorRatioInput', value => isWithinRange(value, 0, 6)) && isValid;
      isValid = validateInput('racionesComidaActual', 'errorRacionesComidaActual', value => isWithinRange(value, 0, 25)) && isValid;

      const ajusteLiviana = document.getElementById('comidaComposicion').value === 'liviana' ? parseFloat(document.getElementById('ajusteLiviana').value) : 0;
      if (document.getElementById('comidaComposicion').value === 'liviana') {
        isValid = validateInput('ajusteLiviana', 'errorAjusteLiviana', value => isWithinRange(value, 0.5, 3)) && isValid;
      }
      const ajustePesada = document.getElementById('comidaComposicion').value === 'pesada' ? parseFloat(document.getElementById('ajustePesada').value) : 0;
      if (document.getElementById('comidaComposicion').value === 'pesada') {
        isValid = validateInput('ajustePesada', 'errorAjustePesada', value => isWithinRange(value, 0.5, 3)) && isValid;
      }

      const ajusteDeporteAntes = document.getElementById('deporteAntes').value === 'si' ? parseFloat(document.getElementById('ajusteDeporteAntes').value) : 0;
      if (document.getElementById('deporteAntes').value === 'si') {
        isValid = validateInput('ajusteDeporteAntes', 'errorAjusteDeporteAntes', value => isWithinRange(value, 0.5, 5)) && isValid;
      }
      const ajusteDeporteDespues = document.getElementById('deporteDespues').value === 'si' ? parseFloat(document.getElementById('ajusteDeporteDespues').value) : 0;
      if (document.getElementById('deporteDespues').value === 'si') {
        isValid = validateInput('ajusteDeporteDespues', 'errorAjusteDeporteDespues', value => isWithinRange(value, 0.5, 5)) && isValid;
      }
      const hipoglucemiaActual = document.getElementById('hipoglucemiaActual').value === 'si' ? -1 : 0;

      if (!isValid) {
        document.getElementById('validationErrorAviso').style.display = 'block';
        return;
      }

      // Hide all results and error messages
      document.getElementById('validationErrorAviso').style.display = 'none';

      const totalInsulina = rapida + lenta;
      const constanteCorreccion = 1800; // Hard-coded value
      const factorCorreccion = totalInsulina > 0 ? constanteCorreccion / totalInsulina : 0; // Evita la división por cero

      // Calculation steps
      let pasosTexto = `Pasos del cálculo:\n\n`;

      // 1. Dosis basada en carbohidratos
      const dosisCarbohidratos = racionesComidaActual * ratioInsulina;
      pasosTexto += `1. Dosis por carbohidratos: Raciones (${racionesComidaActual.toFixed(1)}) x Ratio (${ratioInsulina.toFixed(2)}) = ${dosisCarbohidratos.toFixed(2)} Unidades.\n`;

      // 2. Dosis de corrección (ajuste por glucemia)
      let dosisCorreccion = 0;
      let flechaGlucemia = document.getElementById('flechaGlucemia').value;
      let ajusteFlecha = 0;

      if (glucemiaActual > glucemiaObjetivo) {
        dosisCorreccion = (glucemiaActual - glucemiaObjetivo) / factorCorreccion;
        pasosTexto += `2. Dosis de corrección (por glucemia): (Glucemia actual (${glucemiaActual.toFixed(0)}) - Objetivo (${glucemiaObjetivo.toFixed(0)})) / Factor de Corrección (${factorCorreccion.toFixed(2)}) = ${dosisCorreccion.toFixed(2)} Unidades.\n`;

        // Ajuste por flecha de glucemia (solo si hay corrección al alza)
        if (flechaGlucemia === 'ascenso_lento') {
            ajusteFlecha = 0.5;
        } else if (flechaGlucemia === 'ascenso_rapido') {
            ajusteFlecha = 1;
        }
        if (ajusteFlecha > 0) {
            dosisCorreccion += ajusteFlecha;
            pasosTexto += `   Ajuste por flecha en ascenso: +${ajusteFlecha.toFixed(1)} Unidades. Dosis de corrección final: ${dosisCorreccion.toFixed(2)} Unidades.\n`;
        }
      } else if (glucemiaActual < glucemiaObjetivo) {
        // Dosis de corrección negativa, se resta
        dosisCorreccion = (glucemiaActual - glucemiaObjetivo) / factorCorreccion;
        pasosTexto += `2. Dosis de corrección (por glucemia): (Glucemia actual (${glucemiaActual.toFixed(0)}) - Objetivo (${glucemiaObjetivo.toFixed(0)})) / Factor de Corrección (${factorCorreccion.toFixed(2)}) = ${dosisCorreccion.toFixed(2)} Unidades.\n`;
        
        // Ajuste por flecha de glucemia (solo si hay corrección a la baja)
        if (flechaGlucemia === 'descenso_lento') {
            ajusteFlecha = 0.5;
        } else if (flechaGlucemia === 'descenso_rapido') {
            ajusteFlecha = 1;
        }
        if (ajusteFlecha > 0) {
            dosisCorreccion -= ajusteFlecha; // Restar ajuste
            pasosTexto += `   Ajuste por flecha en descenso: -${ajusteFlecha.toFixed(1)} Unidades. Dosis de corrección final: ${dosisCorreccion.toFixed(2)} Unidades.\n`;
        }
      } else {
        pasosTexto += `2. Dosis de corrección: 0 Unidades (Glucemia en el objetivo).\n`;
      }

      // 3. Ajuste por composición de la comida
      let ajusteComposicion = 0;
      const comidaComposicion = document.getElementById('comidaComposicion').value;
      if (comidaComposicion === 'liviana') {
        ajusteComposicion = -ajusteLiviana;
        pasosTexto += `3. Ajuste por comida liviana: ${ajusteComposicion.toFixed(1)} Unidades.\n`;
      } else if (comidaComposicion === 'pesada') {
        ajusteComposicion = ajustePesada;
        pasosTexto += `3. Ajuste por comida pesada: +${ajusteComposicion.toFixed(1)} Unidades.\n`;
      } else {
        pasosTexto += `3. Ajuste por composición de la comida: 0 Unidades (Comida normal).\n`;
      }

      // 4. Ajuste por deporte
      const ajusteDeporte = -(ajusteDeporteAntes + ajusteDeporteDespues);
      if (ajusteDeporte !== 0) {
        pasosTexto += `4. Ajuste por deporte: ${ajusteDeporte.toFixed(1)} Unidades.\n`;
      } else {
        pasosTexto += `4. Ajuste por deporte: 0 Unidades.\n`;
      }
      
      // 5. Ajuste por hipoglucemia
      const ajusteHipoglucemia = hipoglucemiaActual;
      if (ajusteHipoglucemia !== 0) {
          pasosTexto += `5. Ajuste por hipoglucemia (día anterior): ${ajusteHipoglucemia.toFixed(1)} Unidades.\n`;
      } else {
          pasosTexto += `5. Ajuste por hipoglucemia (día anterior): 0 Unidades.\n`;
      }

      // 6. Dosis total
      const dosisTotal = dosisCarbohidratos + dosisCorreccion + ajusteComposicion + ajusteDeporte + ajusteHipoglucemia;
      const dosisRedondeada = roundToHalf(dosisTotal);
      pasosTexto += `\n6. Dosis Total: ${dosisCarbohidratos.toFixed(2)} (HC) + ${dosisCorreccion.toFixed(2)} (Corrección) + ${ajusteComposicion.toFixed(1)} (Composición) + ${ajusteDeporte.toFixed(1)} (Deporte) + ${ajusteHipoglucemia.toFixed(1)} (Hipoglucemia) = ${dosisTotal.toFixed(2)} Unidades.\n`;
      pasosTexto += `   Dosis Final Redondeada: ${dosisRedondeada.toFixed(1)} Unidades.\n`;

      if (dosisRedondeada < 0) {
        document.getElementById('resultado').innerHTML = 'La dosis de insulina recomendada es: <span style="font-weight: bold; font-size: 1.5em; color: red;">0</span> Unidades.';
        document.getElementById('riesgoHipoglucemiaAviso').style.display = 'block';
        document.getElementById('riesgoHipoglucemiaAviso').textContent = '⚠️ Dosis negativa. No se administre insulina. Por favor, revise los datos introducidos. Es posible que tenga riesgo de hipoglucemia.';
      } else {
        document.getElementById('resultado').innerHTML = 'La dosis de insulina recomendada es: <span style="font-weight: bold; font-size: 1.5em; color: green;">' + dosisRedondeada.toFixed(1) + '</span> Unidades.';

        // Check for high dose
        const dosisAltaThreshold = 0.5 * rapida;
        if (dosisRedondeada > dosisAltaThreshold) {
          document.getElementById('dosisAltaAviso').style.display = 'block';
        }
      }

      if (Math.abs(dosisCorreccion) > 5) {
        document.getElementById('correccionAltaAviso').style.display = 'block';
      } else {
        document.getElementById('correccionAltaAviso').style.display = 'none';
      }

      document.getElementById('pasos').innerHTML = pasosTexto.replace(/\n/g, '<br>');
      document.getElementById('pasos').style.display = 'block';

      // **NOTE:** The window.scrollTo line has been removed from here.
    }
    
    // Initial state check for ratio input
    document.addEventListener('DOMContentLoaded', (event) => {
      document.getElementById('ajusteLivianaContainer').style.display = 'none';
      document.getElementById('ajustePesadaContainer').style.display = 'none';
      document.getElementById('ajusteDeporteAntesContainer').style.display = 'none';
      document.getElementById('ajusteDeporteDespuesContainer').style.display = 'none';
    });
  </script>
</body>
</html>